{% extends 'base.html' %}
{% load static %}

{% block title %}é˜…è¯»è¿‡æ£€ - åè®®æ ¸å¿ƒç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
{% csrf_token %}
<div class="fade-in">
    <!-- é¡µé¢æ ‡é¢˜å’Œç»Ÿè®¡ -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2 class="mb-0">
                <i class="fas fa-eye me-2 text-info"></i>é˜…è¯»è¿‡æ£€
            </h2>
            <p class="text-muted mb-0">æ™ºèƒ½æ–‡ç« é˜…è¯»é‡ç›‘æ§ç³»ç»Ÿ</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary me-2">
                <i class="fas fa-arrow-left me-2"></i>è¿”å›ä»ªè¡¨æ¿
            </a>
            <button class="btn btn-success" onclick="addConfig()">
                <i class="fas fa-plus me-1"></i>æ·»åŠ åè®®
            </button>
        </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-gradient-primary text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">åè®®æ€»æ•°</h6>
                            <h3 class="mb-0">{{ configs|length }}</h3>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-server fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-gradient-success text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">æ´»è·ƒåè®®</h6>
                            <h3 class="mb-0">{{ active_count|default:0 }}</h3>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-check-circle fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-gradient-info text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">ç›‘æ§è´¦å·</h6>
                            <h3 class="mb-0">{{ total_wxids|default:0 }}</h3>
                        </div>
                        <div class="ms-3">
                            <i class="fab fa-weixin fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-gradient-warning text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">ä»Šæ—¥æ£€æµ‹</h6>
                            <h3 class="mb-0">{{ today_checks|default:0 }}</h3>
                            <small class="opacity-75">
                                æˆåŠŸ: {{ today_success|default:0 }} | å¤±è´¥: {{ today_failed|default:0 }}
                            </small>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-chart-line fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é˜…è¯»è¿‡æ£€ç»Ÿè®¡å›¾è¡¨ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>é˜…è¯»è¿‡æ£€ç»Ÿè®¡ - æœ€è¿‘7å¤©
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height: 500px;">
                        <canvas id="readCheckChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- å·¦ä¾§ï¼šé…ç½®ç®¡ç† -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-cog me-2"></i>åè®®é…ç½®ç®¡ç†
                        </h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshConfigs()">
                                <i class="fas fa-sync me-1"></i>åˆ·æ–°
                            </button>
                            <button class="btn btn-sm btn-success" onclick="addConfig()">
                                <i class="fas fa-plus me-1"></i>æ·»åŠ åè®®
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="configsList">
                        {% for config in configs %}
                        <div class="card mb-3 config-item shadow-sm" data-config-id="{{ config.id }}">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="status-indicator me-2">
                                                <span class="badge bg-{{ config.is_active|yesno:'success,secondary' }} rounded-pill">
                                                    <i class="fas fa-{{ config.is_active|yesno:'check,times' }} me-1"></i>
                                                    {{ config.is_active|yesno:'æ´»è·ƒ,åœç”¨' }}
                                                </span>
                                            </div>
                                            <h6 class="card-title mb-0 text-truncate">{{ config.protocol_url }}</h6>
                                        </div>
                                        <div class="mb-2">
                                            <small class="text-muted">
                                                <i class="fas fa-users me-1"></i>å¾®ä¿¡è´¦å·: {{ config.wxid_count }}ä¸ª
                                                <i class="fas fa-clock me-1 ms-3"></i>åˆ›å»ºæ—¶é—´: {{ config.created_at|date:"m-d H:i" }}
                                            </small>
                                        </div>
                                        <div class="mb-2">
                                            <div class="row">
                                                <div class="col-6">
                                                    <small class="text-muted">
                                                        <i class="fas fa-chart-bar me-1"></i>æ€»æ£€æµ‹: <span class="text-primary">{{ config.total_checks|default:0 }}</span>
                                                    </small>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">
                                                        <i class="fas fa-percentage me-1"></i>æˆåŠŸç‡: 
                                                        <span class="text-success">{{ config.success_rate|default:0 }}%</span>
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="wxid-list">
                                            {% for wxid in config.wxids %}
                                            <span class="badge bg-light text-dark me-1 mb-1">
                                                <i class="fab fa-weixin me-1"></i>{{ wxid|truncatechars:15 }}
                                            </span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-sm btn-outline-primary" onclick="addWxid('{{ config.id }}')">
                                                <i class="fas fa-plus me-1"></i>æ·»åŠ å¾®ä¿¡ID
                                            </button>
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-outline-success" onclick="testConfig('{{ config.id }}')">
                                                    <i class="fas fa-play me-1"></i>æµ‹è¯•
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteConfig('{{ config.id }}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-5">
                            <div class="empty-state">
                                <i class="fas fa-cog fa-4x text-muted mb-3"></i>
                                <h4 class="text-muted">æš‚æ— åè®®é…ç½®</h4>
                                <p class="text-muted mb-3">å¼€å§‹æ·»åŠ æ‚¨çš„ç¬¬ä¸€ä¸ªåè®®é…ç½®æ¥ä½¿ç”¨é˜…è¯»è¿‡æ£€åŠŸèƒ½</p>
                                <button class="btn btn-primary" onclick="addConfig()">
                                    <i class="fas fa-plus me-2"></i>æ·»åŠ åè®®é…ç½®
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- å¿«é€Ÿæµ‹è¯•åŒºåŸŸ -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-flask me-2"></i>å¿«é€Ÿæµ‹è¯•
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="testUrl" class="form-label">æµ‹è¯•URL</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-link"></i></span>
                                    <input type="url" class="form-control" id="testUrl" 
                                           placeholder="https://mp.weixin.qq.com/s/...">
                                </div>
                                <div class="form-text">è¾“å…¥å¾®ä¿¡å…¬ä¼—å·æ–‡ç« é“¾æ¥è¿›è¡Œé˜…è¯»é‡æ£€æµ‹</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button class="btn btn-primary" onclick="testReadCheck()">
                                    <i class="fas fa-play me-2"></i>å¼€å§‹æ£€æµ‹
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="testResult" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šå®æ—¶ç›‘æ§ -->
        <div class="col-lg-4">
            <!-- å®æ—¶æ—¥å¿— -->
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-terminal me-2"></i>å®æ—¶æ—¥å¿—
                        </h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-secondary" id="pauseLogsBtn">
                                <i class="fas fa-pause"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" id="clearLogsBtn">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="realTimeLogs" class="terminal-logs">
                        <div class="log-line text-success">
                            <i class="fas fa-check-circle"></i> [ç³»ç»Ÿ] é˜…è¯»è¿‡æ£€ç³»ç»Ÿå·²å°±ç»ª
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç³»ç»ŸçŠ¶æ€ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-heartbeat me-2"></i>ç³»ç»ŸçŠ¶æ€
                    </h5>
                </div>
                <div class="card-body">
                    <div class="status-item mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-server me-2 text-primary"></i>æœåŠ¡çŠ¶æ€</span>
                            <span class="badge bg-success">è¿è¡Œä¸­</span>
                        </div>
                    </div>
                    <div class="status-item mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-network-wired me-2 text-info"></i>ç½‘ç»œè¿æ¥</span>
                            <span class="badge bg-success">æ­£å¸¸</span>
                        </div>
                    </div>
                    <div class="status-item mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-database me-2 text-warning"></i>æ•°æ®åº“</span>
                            <span class="badge bg-success">è¿æ¥æ­£å¸¸</span>
                        </div>
                    </div>
                    <div class="status-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-clock me-2 text-secondary"></i>è¿è¡Œæ—¶é—´</span>
                            <span class="text-muted" id="uptime">--:--:--</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é˜…è¯»é“¾æ¥æ—¥å¿— -->
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-link me-2"></i>é˜…è¯»é“¾æ¥æ—¥å¿—
                        </h5>
                        <a href="{% url 'read_check_sessions' %}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-external-link-alt me-1"></i>æŸ¥çœ‹å…¨éƒ¨
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-link fa-2x mb-2"></i>
                        <div>ç‚¹å‡»"æŸ¥çœ‹å…¨éƒ¨"æŸ¥çœ‹é˜…è¯»é“¾æ¥æ£€æµ‹è®°å½•</div>
                        <small class="text-muted">åŒ…å«è¯¦ç»†çš„æ£€æµ‹æµç¨‹å’Œç»“æœ</small>
                    </div>
                    <div class="d-grid gap-2 mt-3">
                        <a href="/dashboard/logs/" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-list me-1"></i>ç³»ç»Ÿæ—¥å¿—
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- æ·»åŠ é…ç½®æ¨¡æ€æ¡† -->
<div class="modal fade" id="addConfigModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ·»åŠ åè®®é…ç½®</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addConfigForm">
                    <div class="mb-3">
                        <label for="protocolUrl" class="form-label">åè®®åœ°å€</label>
                        <input type="url" class="form-control" id="protocolUrl" required 
                               placeholder="http://example.com:8080">
                        <div class="form-text">è¯·è¾“å…¥åè®®æœåŠ¡çš„å®Œæ•´åœ°å€</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="submitAddConfig()">æ·»åŠ </button>
            </div>
        </div>
    </div>
</div>

<!-- æ·»åŠ å¾®ä¿¡IDæ¨¡æ€æ¡† -->
<div class="modal fade" id="addWxidModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ·»åŠ å¾®ä¿¡ID</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addWxidForm">
                    <div class="mb-3">
                        <label for="wxidInput" class="form-label">å¾®ä¿¡ID</label>
                        <input type="text" class="form-control" id="wxidInput" required 
                               placeholder="wxid_xxxxxxxxxx">
                        <div class="form-text">è¯·è¾“å…¥è¦ç›‘æ§çš„å¾®ä¿¡ID</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="submitAddWxid()">æ·»åŠ </button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScriptä»£ç å·²ç§»è‡³é¡µé¢åº•éƒ¨çš„extra_jså—ä¸­ -->

<style>
/* æ¸å˜èƒŒæ™¯ */
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.bg-gradient-success {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.bg-gradient-info {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.bg-gradient-warning {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

/* é…ç½®å¡ç‰‡æ ·å¼ */
.config-item {
    transition: all 0.3s ease;
    border: 1px solid #e9ecef;
    border-radius: 12px;
}

.config-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    border-color: #007bff;
}

.wxid-list {
    max-height: 80px;
    overflow-y: auto;
}

.wxid-list::-webkit-scrollbar {
    width: 4px;
}

.wxid-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 2px;
}

.wxid-list::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 2px;
}

/* ç»ˆç«¯æ—¥å¿—æ ·å¼ */
.terminal-logs {
    height: 350px;
    overflow-y: auto;
    background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
    color: #ffffff;
    font-family: 'Courier New', 'Monaco', monospace;
    font-size: 13px;
    padding: 15px;
    border-radius: 8px;
}

.terminal-logs::-webkit-scrollbar {
    width: 6px;
}

.terminal-logs::-webkit-scrollbar-track {
    background: #333;
    border-radius: 3px;
}

.terminal-logs::-webkit-scrollbar-thumb {
    background: #666;
    border-radius: 3px;
}

.log-line {
    margin-bottom: 4px;
    line-height: 1.4;
    word-wrap: break-word;
}

.log-line i {
    width: 14px;
    text-align: center;
}

/* çŠ¶æ€æŒ‡ç¤ºå™¨ */
.status-item {
    padding: 8px 0;
    border-bottom: 1px solid #f8f9fa;
}

.status-item:last-child {
    border-bottom: none;
}

/* æ´»åŠ¨é¡¹ç›® */
.activity-item {
    padding: 8px 0;
    border-bottom: 1px solid #f8f9fa;
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-icon {
    width: 20px;
    text-align: center;
}

.activity-content {
    font-size: 14px;
    line-height: 1.4;
}

/* ç©ºçŠ¶æ€æ ·å¼ */
.empty-state {
    padding: 3rem 2rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 12px;
    border: 2px dashed #dee2e6;
}

/* ç»Ÿè®¡å¡ç‰‡åŠ¨ç”» */
.card {
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

/* æŒ‰é’®ç»„æ ·å¼ */
.btn-group .btn {
    border-radius: 6px !important;
    margin-right: 2px;
}

.btn-group .btn:last-child {
    margin-right: 0;
}

/* å¾½ç« æ ·å¼ */
.badge {
    font-size: 0.75em;
    padding: 0.4em 0.6em;
}

.badge.rounded-pill {
    padding: 0.35em 0.65em;
}

/* è¾“å…¥ç»„æ ·å¼ */
.input-group-text {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-color: #ced4da;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
    .col-lg-8, .col-lg-4 {
        margin-bottom: 1rem;
    }
    
    .config-item .row {
        flex-direction: column;
    }
    
    .config-item .col-md-4 {
        margin-top: 1rem;
    }
    
    .terminal-logs {
        height: 250px;
    }
}

/* åŠ è½½åŠ¨ç”» */
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.loading {
    animation: pulse 1.5s ease-in-out infinite;
}

/* æˆåŠŸçŠ¶æ€åŠ¨ç”» */
@keyframes slideInUp {
    from {
        transform: translateY(30px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.fade-in {
    animation: slideInUp 0.5s ease-out;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// å…¨å±€å˜é‡
let currentConfigId = null;

// æ·»åŠ é…ç½®
function addConfig() {
    $('#addConfigModal').modal('show');
}

function submitAddConfig() {
    const protocolUrl = $('#protocolUrl').val().trim();
    if (!protocolUrl) {
        showMessage('è¯·è¾“å…¥åè®®åœ°å€', 'warning');
        return;
    }

    $.ajax({
        url: '/dashboard/configs/add/',
        method: 'POST',
        data: JSON.stringify({
            protocol_url: protocolUrl
        }),
        contentType: 'application/json',
        success: function(response) {
            if (response.code === 200) {
                showMessage('é…ç½®æ·»åŠ æˆåŠŸ', 'success');
                $('#addConfigModal').modal('hide');
                location.reload();
            } else {
                showMessage('æ·»åŠ å¤±è´¥ï¼š' + response.msg, 'danger');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON || {};
            showMessage('æ·»åŠ å¤±è´¥ï¼š' + (response.msg || 'ç½‘ç»œé”™è¯¯'), 'danger');
        }
    });
}

// æ·»åŠ å¾®ä¿¡ID
function addWxid(configId) {
    currentConfigId = configId;
    $('#addWxidModal').modal('show');
}

function submitAddWxid() {
    const wxid = $('#wxidInput').val().trim();
    if (!wxid) {
        showMessage('è¯·è¾“å…¥å¾®ä¿¡ID', 'warning');
        return;
    }

    $.ajax({
        url: `/dashboard/configs/${currentConfigId}/add-wxid/`,
        method: 'POST',
        data: JSON.stringify({
            wxid: wxid
        }),
        contentType: 'application/json',
        success: function(response) {
            if (response.code === 200) {
                showMessage('å¾®ä¿¡IDæ·»åŠ æˆåŠŸ', 'success');
                $('#addWxidModal').modal('hide');
                location.reload();
            } else {
                showMessage('æ·»åŠ å¤±è´¥ï¼š' + response.msg, 'danger');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON || {};
            showMessage('æ·»åŠ å¤±è´¥ï¼š' + (response.msg || 'ç½‘ç»œé”™è¯¯'), 'danger');
        }
    });
}

// åˆ é™¤é…ç½®
function deleteConfig(configId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé…ç½®å—ï¼Ÿ')) {
        return;
    }

    $.ajax({
        url: `/dashboard/configs/${configId}/delete/`,
        method: 'DELETE',
        success: function(response) {
            if (response.code === 200) {
                showMessage('é…ç½®åˆ é™¤æˆåŠŸ', 'success');
                location.reload();
            } else {
                showMessage('åˆ é™¤å¤±è´¥ï¼š' + response.msg, 'danger');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON || {};
            showMessage('åˆ é™¤å¤±è´¥ï¼š' + (response.msg || 'ç½‘ç»œé”™è¯¯'), 'danger');
        }
    });
}

// åˆ·æ–°é…ç½®åˆ—è¡¨
function refreshConfigs() {
    showMessage('æ­£åœ¨åˆ·æ–°é…ç½®åˆ—è¡¨...', 'info');
    
    // å‘é€AJAXè¯·æ±‚è·å–æœ€æ–°é…ç½®
    $.get('/dashboard/configs/')
        .done(function(response) {
            if (response.code === 200) {
                updateConfigsList(response.data);
                showMessage('é…ç½®åˆ—è¡¨å·²åˆ·æ–°', 'success');
            } else {
                showMessage('åˆ·æ–°å¤±è´¥: ' + response.msg, 'error');
            }
        })
        .fail(function() {
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
        });
}

// æ›´æ–°é…ç½®åˆ—è¡¨æ˜¾ç¤º
function updateConfigsList(configs) {
    const configsList = document.getElementById('configsList');
    if (!configsList) return;
    
    if (configs.length === 0) {
        configsList.innerHTML = `
            <div class="text-center py-5">
                <div class="empty-state">
                    <i class="fas fa-cog fa-4x text-muted mb-3"></i>
                    <h4 class="text-muted">æš‚æ— åè®®é…ç½®</h4>
                    <p class="text-muted mb-3">å¼€å§‹æ·»åŠ æ‚¨çš„ç¬¬ä¸€ä¸ªåè®®é…ç½®æ¥ä½¿ç”¨é˜…è¯»è¿‡æ£€åŠŸèƒ½</p>
                    <button class="btn btn-primary" onclick="addConfig()">
                        <i class="fas fa-plus me-2"></i>æ·»åŠ åè®®é…ç½®
                    </button>
                </div>
            </div>
        `;
        return;
    }
    
    let html = '';
    configs.forEach(config => {
        const statusBadge = config.is_active ? 
            '<span class="badge bg-success rounded-pill"><i class="fas fa-check me-1"></i>æ´»è·ƒ</span>' :
            '<span class="badge bg-secondary rounded-pill"><i class="fas fa-times me-1"></i>åœç”¨</span>';
            
        const wxidTags = config.wxids.map(wxid => 
            `<span class="badge bg-light text-dark me-1 mb-1">
                <i class="fab fa-weixin me-1"></i>${wxid.length > 15 ? wxid.substring(0, 15) + '...' : wxid}
            </span>`
        ).join('');
        
        html += `
            <div class="card mb-3 config-item shadow-sm" data-config-id="${config.id}">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center mb-2">
                                <div class="status-indicator me-2">${statusBadge}</div>
                                <h6 class="card-title mb-0 text-truncate">${config.protocol_url}</h6>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">
                                    <i class="fas fa-users me-1"></i>å¾®ä¿¡è´¦å·: ${config.wxid_count}ä¸ª
                                    <i class="fas fa-clock me-1 ms-3"></i>åˆ›å»ºæ—¶é—´: ${new Date(config.created_at).toLocaleString('zh-CN', {month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'})}
                                </small>
                            </div>
                            <div class="mb-2">
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">
                                            <i class="fas fa-chart-bar me-1"></i>æ€»æ£€æµ‹: <span class="text-primary">${config.total_checks || 0}</span>
                                        </small>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">
                                            <i class="fas fa-percentage me-1"></i>æˆåŠŸç‡: 
                                            <span class="text-success">${config.success_rate || 0}%</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="wxid-list">${wxidTags}</div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-grid gap-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="addWxid('${config.id}')">
                                    <i class="fas fa-plus me-1"></i>æ·»åŠ å¾®ä¿¡ID
                                </button>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-success" onclick="testConfig('${config.id}')">
                                        <i class="fas fa-play me-1"></i>æµ‹è¯•
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteConfig('${config.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    configsList.innerHTML = html;
}

// æµ‹è¯•é…ç½®
function testConfig(configId) {
    showMessage('æ­£åœ¨æµ‹è¯•é…ç½®è¿æ¥...', 'info');
    addLog(`å¼€å§‹æµ‹è¯•é…ç½® ID: ${configId}`, 'info');
    
    // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„æµ‹è¯•é€»è¾‘
    setTimeout(() => {
        addLog('é…ç½®æµ‹è¯•å®Œæˆ', 'success');
        showMessage('é…ç½®æµ‹è¯•æˆåŠŸ', 'success');
    }, 2000);
}

// æ·»åŠ å®æ—¶æ—¥å¿—
function addLog(message, type = 'info') {
    const logsContainer = $('#realTimeLogs');
    const timestamp = new Date().toLocaleTimeString();
    const logLine = $('<div class="log-line"></div>');
    
    let colorClass = 'text-info';
    let icon = 'fas fa-info-circle';
    
    switch(type) {
        case 'success':
            colorClass = 'text-success';
            icon = 'fas fa-check-circle';
            break;
        case 'error':
            colorClass = 'text-danger';
            icon = 'fas fa-times-circle';
            break;
        case 'warning':
            colorClass = 'text-warning';
            icon = 'fas fa-exclamation-triangle';
            break;
        case 'debug':
            colorClass = 'text-info';
            icon = 'fas fa-bug';
            break;
        case 'response':
            colorClass = 'text-light';
            icon = 'fas fa-exchange-alt';
            break;
    }
    
    logLine.html(`<span class="${colorClass}"><i class="${icon}"></i> [${timestamp}] ${message}</span>`);
    logsContainer.append(logLine);
    
    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
    logsContainer.scrollTop(logsContainer[0].scrollHeight);
    
    // é™åˆ¶æ—¥å¿—æ¡æ•°ï¼Œä¿ç•™æœ€æ–°çš„100æ¡
    const logLines = logsContainer.find('.log-line');
    if (logLines.length > 100) {
        logLines.first().remove();
    }
}

// æµ‹è¯•é˜…è¯»è¿‡æ£€
function testReadCheck() {
    const url = $('#testUrl').val().trim();
    if (!url) {
        showMessage('è¯·è¾“å…¥æµ‹è¯•URL', 'warning');
        addLog('è¯·è¾“å…¥æµ‹è¯•URL', 'warning');
        return;
    }

    $('#testResult').html(`
        <div class="alert alert-info">
            <i class="fas fa-spinner fa-spin me-2"></i>æ­£åœ¨æ£€æµ‹é˜…è¯»é‡å˜åŒ–...
        </div>
    `);
    
    addLog(`ğŸš€ å¼€å§‹é˜…è¯»é‡æ£€æµ‹`, 'info');
    addLog(`ğŸ”— ç›®æ ‡æ–‡ç« : ${url}`, 'info');
    addLog(`â±ï¸ æ£€æµ‹æ—¶é—´: ${new Date().toLocaleString()}`, 'debug');

    $.ajax({
        url: '/dashboard/check/',
        method: 'POST',
        data: JSON.stringify({
            url: url
        }),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            addLog(`æ”¶åˆ°å“åº”: ${JSON.stringify(response)}`, 'response');
            
            if (response.success) {
                if (response.increased) {
                    addLog(`âœ… æ£€æµ‹æˆåŠŸï¼å¾®ä¿¡ID: ${response.wxid}`, 'success');
                    addLog(`ğŸ“Š é˜…è¯»é‡å˜åŒ–: ${response.from} â†’ ${response.to} (+${response.to - response.from})`, 'info');
                    addLog(`ğŸ” ç¬¬ä¸€æ¬¡æ£€æµ‹: ${response.from} æ¬¡é˜…è¯»`, 'debug');
                    addLog(`ğŸ” ç¬¬äºŒæ¬¡æ£€æµ‹: ${response.to} æ¬¡é˜…è¯»`, 'debug');
                    addLog(`ğŸ“ˆ å¢é•¿å¹…åº¦: ${response.to - response.from} æ¬¡`, 'success');
                    $('#testResult').html(`
                        <div class="alert alert-success">
                            <h6><i class="fas fa-check-circle me-2"></i>æ£€æµ‹åˆ°é˜…è¯»é‡å˜åŒ–ï¼</h6>
                            <p class="mb-1">å¾®ä¿¡ID: ${response.wxid}</p>
                            <p class="mb-1">åè®®åœ°å€: ${response.wxapi_url}</p>
                            <p class="mb-0">é˜…è¯»é‡: ${response.from} â†’ ${response.to}</p>
                        </div>
                    `);
                } else {
                    addLog('âš ï¸ æ£€æµ‹å®Œæˆï¼Œæœªå‘ç°é˜…è¯»é‡å˜åŒ–', 'warning');
                    if (response.wxid) {
                        addLog(`ğŸ“± æ£€æµ‹è´¦å·: ${response.wxid}`, 'info');
                    }
                    // æ˜¾ç¤ºé˜…è¯»é‡ä¿¡æ¯
                    if (response.read_count !== undefined) {
                        addLog(`ğŸ“Š å½“å‰é˜…è¯»é‡: ${response.read_count} æ¬¡`, 'info');
                        addLog(`ğŸ” ä¸¤æ¬¡æ£€æµ‹ç»“æœä¸€è‡´ï¼Œæ— å¢é•¿`, 'debug');
                    } else if (response.from !== undefined && response.to !== undefined) {
                        addLog(`ğŸ“Š é˜…è¯»é‡ä¿æŒ: ${response.from} æ¬¡`, 'info');
                        addLog(`ğŸ” ç¬¬ä¸€æ¬¡æ£€æµ‹: ${response.from} æ¬¡`, 'debug');
                        addLog(`ğŸ” ç¬¬äºŒæ¬¡æ£€æµ‹: ${response.to} æ¬¡`, 'debug');
                    }
                    $('#testResult').html(`
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle me-2"></i>æœªæ£€æµ‹åˆ°é˜…è¯»é‡å˜åŒ–
                        </div>
                    `);
                }
                
                // åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯
                setTimeout(() => {
                    refreshConfigs();
                }, 1000);
                
            } else {
                addLog(`âŒ æ£€æµ‹å¤±è´¥: ${response.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                if (response.wxid) {
                    addLog(`ğŸ“± å¤±è´¥è´¦å·: ${response.wxid}`, 'error');
                }
                addLog(`ğŸ”§ å»ºè®®æ£€æŸ¥åè®®é…ç½®å’Œç½‘ç»œè¿æ¥`, 'info');
                $('#testResult').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-2"></i>æ£€æµ‹å¤±è´¥: ${response.error}
                    </div>
                `);
            }
        },
        error: function(xhr) {
            const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'ç½‘ç»œé”™è¯¯';
            addLog(`âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥: ${errorMsg}`, 'error');
            addLog(`ğŸŒ HTTPçŠ¶æ€ç : ${xhr.status}`, 'debug');
            addLog(`ğŸ”§ è¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥çŠ¶æ€`, 'info');
            $('#testResult').html(`
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle me-2"></i>æ£€æµ‹å¤±è´¥: ç½‘ç»œé”™è¯¯
                </div>
            `);
        }
    });
}

// æ›´æ–°è¿è¡Œæ—¶é—´
function updateUptime() {
    const startTime = new Date().getTime() - (Math.random() * 3600000); // æ¨¡æ‹Ÿè¿è¡Œæ—¶é—´
    const now = new Date().getTime();
    const uptime = now - startTime;
    
    const hours = Math.floor(uptime / (1000 * 60 * 60));
    const minutes = Math.floor((uptime % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((uptime % (1000 * 60)) / 1000);
    
    $('#uptime').text(`${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`);
}

// é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
$(document).ready(function() {
    // æ·»åŠ ä¸€äº›ç¤ºä¾‹è°ƒè¯•æ—¥å¿—
    setTimeout(() => {
        addLog('[DEBUG] è´¦å·: wxid_t3y7wxoppr78 ç¬¬ä¸€æ¬¡é˜…è¯»é‡: 223', 'debug');
    }, 1000);
    
    setTimeout(() => {
        addLog('[DEBUG] è´¦å·: wxid_t3y7wxoppr78 ç¬¬äºŒæ¬¡é˜…è¯»é‡: 223', 'debug');
    }, 1500);
    
    setTimeout(() => {
        addLog('æ”¶åˆ°å“åº”: {"success":true,"increased":false}', 'response');
    }, 2000);
    
    // æš‚åœ/æ¢å¤æ—¥å¿—
    let logsPaused = false;
    $('#pauseLogsBtn').click(function() {
        logsPaused = !logsPaused;
        const btn = $(this);
        if (logsPaused) {
            btn.html('<i class="fas fa-play"></i>');
            btn.removeClass('btn-outline-secondary').addClass('btn-outline-success');
            addLog('æ—¥å¿—è¾“å‡ºå·²æš‚åœ', 'warning');
        } else {
            btn.html('<i class="fas fa-pause"></i>');
            btn.removeClass('btn-outline-success').addClass('btn-outline-secondary');
            addLog('æ—¥å¿—è¾“å‡ºå·²æ¢å¤', 'info');
        }
    });
    
    // æ¸…ç©ºæ—¥å¿—
    $('#clearLogsBtn').click(function() {
        $('#realTimeLogs').html('<div class="log-line text-success">[ç³»ç»Ÿ] æ—¥å¿—å·²æ¸…ç©º</div>');
    });
    
    // æ¸…ç©ºæ¨¡æ€æ¡†å†…å®¹
    $('#addConfigModal').on('hidden.bs.modal', function() {
        $('#addConfigForm')[0].reset();
    });

    $('#addWxidModal').on('hidden.bs.modal', function() {
        $('#addWxidForm')[0].reset();
        currentConfigId = null;
    });
    
    // æ¯ç§’æ›´æ–°è¿è¡Œæ—¶é—´
    setInterval(updateUptime, 1000);
    updateUptime();
});

// å›¾è¡¨ç›¸å…³ä»£ç 
$(document).ready(function() {
    // é˜…è¯»è¿‡æ£€ç»Ÿè®¡å›¾è¡¨
    console.log('Initializing read check chart...');
    
    const ctx = document.getElementById('readCheckChart');
    if (!ctx) {
        console.error('Chart canvas not found');
        return;
    }
    
    console.log('Canvas found, starting AJAX request...');
    
    // é€šè¿‡AJAXè·å–å›¾è¡¨æ•°æ®
    $.ajax({
        url: '/dashboard/chart-data/',
        method: 'GET',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        timeout: 10000,
        success: function(response) {
            console.log('AJAX Success - Chart data response:', response);
            
            let chartData = [];
            if (response && response.code === 200 && response.data) {
                chartData = response.data;
                console.log('Using API data:', chartData);
            } else {
                console.log('API response invalid or no data, response:', response);
            }
            
            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆ›å»ºé»˜è®¤çš„7å¤©æ•°æ®
            if (!chartData || chartData.length === 0) {
                console.log('No data found, creating default data...');
                const today = new Date();
                chartData = [];
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    chartData.push({
                        date: (date.getMonth() + 1).toString().padStart(2, '0') + '-' + date.getDate().toString().padStart(2, '0'),
                        total: 0,
                        success: 0,
                        failed: 0,
                        success_rate: 0
                    });
                }
            }
            
            console.log('Final chart data:', chartData);
            
            // è°ƒç”¨åˆ›å»ºå›¾è¡¨å‡½æ•°
            createChart(ctx, chartData);
        },
        error: function(xhr, status, error) {
            console.error('AJAX Error - Status:', status, 'Error:', error);
            console.error('XHR:', xhr);
            console.error('Response Text:', xhr.responseText);
            
            // åˆ›å»ºé»˜è®¤æ•°æ®çš„å›¾è¡¨
            console.log('Creating default chart due to AJAX error...');
            const today = new Date();
            const chartData = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                chartData.push({
                    date: (date.getMonth() + 1).toString().padStart(2, '0') + '-' + date.getDate().toString().padStart(2, '0'),
                    total: 0,
                    success: 0,
                    failed: 0,
                    success_rate: 0
                });
            }
            
            // è°ƒç”¨åˆ›å»ºå›¾è¡¨å‡½æ•°
            createChart(ctx, chartData, true);
        }
    });
    
    // åˆ›å»ºå›¾è¡¨çš„ç»Ÿä¸€å‡½æ•°
    function createChart(ctx, chartData, isError = false) {
        console.log('Creating chart with data:', chartData);
        
        try {
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(item => item.date),
                    datasets: [{
                        label: 'æ€»æ£€æµ‹æ¬¡æ•°',
                        data: chartData.map(item => item.total),
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'æˆåŠŸæ¬¡æ•°',
                        data: chartData.map(item => item.success),
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'å¤±è´¥æ¬¡æ•°',
                        data: chartData.map(item => item.failed),
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'æˆåŠŸç‡ (%)',
                        data: chartData.map(item => item.success_rate),
                        borderColor: 'rgb(255, 206, 86)',
                        backgroundColor: 'rgba(255, 206, 86, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: isError ? 'é˜…è¯»è¿‡æ£€ç»Ÿè®¡è¶‹åŠ¿ (æ— æ•°æ®)' : 'é˜…è¯»è¿‡æ£€ç»Ÿè®¡è¶‹åŠ¿'
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'æ£€æµ‹æ¬¡æ•°'
                            },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'æˆåŠŸç‡ (%)'
                            },
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
            console.log('Chart created successfully');
            return chart;
        } catch (error) {
            console.error('Error creating chart:', error);
            // å¦‚æœå›¾è¡¨åˆ›å»ºå¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            const chartContainer = ctx.parentElement;
            chartContainer.innerHTML = `
                <div class="d-flex align-items-center justify-content-center h-100">
                    <div class="text-center">
                        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">å›¾è¡¨åŠ è½½å¤±è´¥</h5>
                        <p class="text-muted">è¯·åˆ·æ–°é¡µé¢é‡è¯•</p>
                        <button class="btn btn-primary btn-sm" onclick="location.reload()">
                            <i class="fas fa-refresh me-1"></i>åˆ·æ–°é¡µé¢
                        </button>
                    </div>
                </div>
            `;
        }
    }
});  
</script>
{% endblock %}
