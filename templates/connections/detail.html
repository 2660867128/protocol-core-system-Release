{% extends 'base.html' %}

{% block title %}连接详情 - 协议核心管理系统{% endblock %}

{% block content %}
{% csrf_token %}
<div class="fade-in">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fas fa-info-circle me-2 text-primary"></i>连接详情
        </h2>
        <div>
            <a href="{% url 'connection_edit' connection.pk %}" class="btn btn-warning me-2">
                <i class="fas fa-edit me-2"></i>编辑
            </a>
            <a href="{% url 'connection_list' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>返回列表
            </a>
        </div>
    </div>

    <!-- 连接信息概览 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <!-- 基本信息 -->
                        <div class="col-lg-8">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="info-item">
                                        <label class="info-label">
                                            <i class="fas fa-tag me-2 text-primary"></i>连接名称
                                        </label>
                                        <div class="info-value fw-bold text-dark">{{ connection.name }}</div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="info-item">
                                        <label class="info-label">
                                            <i class="fas fa-cube me-2 text-info"></i>连接类型
                                        </label>
                                        <div class="info-value">
                                            <span class="badge bg-info fs-6">{{ connection.connection_type }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 mb-3">
                                    <div class="info-item">
                                        <label class="info-label">
                                            <i class="fas fa-link me-2 text-success"></i>接口地址
                                        </label>
                                        <div class="info-value">
                                            <code class="bg-light p-2 rounded">{{ connection.url }}</code>
                                        </div>
                                    </div>
                                </div>
                                {% if connection.admin_key %}
                                <div class="col-md-6 mb-3">
                                    <div class="info-item">
                                        <label class="info-label">
                                            <i class="fas fa-key me-2 text-warning"></i>管理员密钥
                                        </label>
                                        <div class="info-value">
                                            <span class="text-muted">••••••••••••••••</span>
                                            <small class="text-success ms-2">
                                                <i class="fas fa-check-circle me-1"></i>已配置
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                <div class="col-md-6 mb-3">
                                    <div class="info-item">
                                        <label class="info-label">
                                            <i class="fas fa-power-off me-2 text-secondary"></i>状态
                                        </label>
                                        <div class="info-value">
                                            <span class="badge bg-{{ connection.is_active|yesno:'success,secondary' }} fs-6">
                                                <i class="fas fa-{{ connection.is_active|yesno:'check,times' }} me-1"></i>
                                                {{ connection.is_active|yesno:'启用,禁用' }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="info-item">
                                        <label class="info-label">
                                            <i class="fas fa-clock me-2 text-muted"></i>创建时间
                                        </label>
                                        <div class="info-value">{{ connection.created_at|date:"Y-m-d H:i:s" }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 统计信息 -->
                        <div class="col-lg-4">
                            <div class="stats-container">
                                <div class="row text-center g-3">
                                    <div class="col-6">
                                        <div class="stat-card bg-primary bg-opacity-10 rounded p-3">
                                            <div class="stat-icon text-primary mb-2">
                                                <i class="fas fa-users fa-2x"></i>
                                            </div>
                                            <div class="stat-number text-primary fw-bold fs-4">{{ connection.auth_codes.count }}</div>
                                            <div class="stat-label text-muted small">授权码总数</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-card bg-success bg-opacity-10 rounded p-3">
                                            <div class="stat-icon text-success mb-2">
                                                <i class="fas fa-check-circle fa-2x"></i>
                                            </div>
                                            <div class="stat-number text-success fw-bold fs-4">{{ connection.auth_codes.count }}</div>
                                            <div class="stat-label text-muted small">有效授权码</div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="stat-card bg-info bg-opacity-10 rounded p-3">
                                            <div class="stat-icon text-info mb-2">
                                                <i class="fas fa-file-alt fa-2x"></i>
                                            </div>
                                            <div class="stat-number text-info fw-bold fs-4">{{ connection.logs.count }}</div>
                                            <div class="stat-label text-muted small">连接日志</div>
                                            <div class="mt-2">
                                                <a href="{% url 'logs' %}?connection={{ connection.pk }}" class="btn btn-outline-info btn-sm">
                                                    <i class="fas fa-external-link-alt me-1"></i>查看详细
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- 微信管理 -->
        <div class="col-12">

            <!-- 微信管理 -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-gradient-success text-white border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fab fa-weixin me-2"></i>微信管理
                        </h5>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-light text-dark me-3">{{ connection.auth_codes.count }} 个账号</span>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-light text-success" onclick="refreshWechatInfo()" id="refreshBtn">
                                    <i class="fas fa-sync me-1"></i>刷新信息
                                </button>
                                {% if connection.connection_type == 'WeCharPadPro' %}
                                    <button class="btn btn-sm btn-primary" onclick="generateAuthCode('{{ connection.pk }}')">
                                        <i class="fas fa-key me-1"></i>生成授权码
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="addWechatAccount('{{ connection.pk }}')">
                                        <i class="fas fa-plus me-1"></i>添加微信
                                    </button>
                                {% else %}
                                    <button class="btn btn-sm btn-warning" onclick="addWechatAccount('{{ connection.pk }}')">
                                        <i class="fas fa-plus me-1"></i>添加微信
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="wechatTableContainer">
                        {% if connection.auth_codes.all %}
                            <div class="table-responsive">
                                <table class="table table-hover mb-0 wechat-table" id="wechatTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="border-0 fw-bold text-dark">序号</th>
                                            <th class="border-0 fw-bold text-dark">用户信息</th>
                                            <th class="border-0 fw-bold text-dark">状态</th>
                                            <th class="border-0 fw-bold text-dark">最后查询</th>
                                            <th class="border-0 fw-bold text-dark text-center">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="wechatTableBody">
                                        {% for auth_code in connection.auth_codes.all %}
                                        <tr class="wechat-row" data-wxid="{{ auth_code.code }}" id="row-{{ forloop.counter }}">
                                            <td class="align-middle">
                                                <div class="d-flex align-items-center">
                                                    <div class="wechat-number">
                                                        {{ forloop.counter }}
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="align-middle">
                                                <div class="d-flex align-items-center">
                                                    <div class="wechat-avatar me-3" id="avatar-{{ forloop.counter }}">
                                                        {% if auth_code.avatar_url %}
                                                            <img src="{{ auth_code.avatar_url }}" alt="头像" class="wechat-avatar-img">
                                                        {% else %}
                                                            <i class="fab fa-weixin"></i>
                                                        {% endif %}
                                                    </div>
                                                    <div class="flex-grow-1">
                                                        <div class="wechat-nickname" id="nickname-{{ forloop.counter }}">
                                                            {{ auth_code.nickname|default:auth_code.remark|default:"未获取昵称" }}
                                                        </div>
                                                        <div class="wechat-id">
                                                            <i class="fas fa-id-card me-1"></i>
                                                            <code>{{ auth_code.code }}</code>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="align-middle">
                                                {% if connection.connection_type == 'WeCharPadPro' %}
                                                    {% if auth_code.is_online is None %}
                                                        <!-- WeCharPadPro未知状态显示登录Pro按钮 -->
                                                        <button class="btn btn-sm btn-outline-primary auto-login-btn" 
                                                                onclick="loginPro('{{ connection.pk }}', '{{ auth_code.code }}', {{ forloop.counter }})"
                                                                title="登录Pro" data-bs-toggle="tooltip"
                                                                id="login-pro-btn-{{ forloop.counter }}">
                                                            <i class="fas fa-sign-in-alt me-1"></i>登录Pro
                                                        </button>
                                                    {% else %}
                                                        <span class="wechat-status status-{{ auth_code.status_class }}" id="status-{{ forloop.counter }}">
                                                            <i class="fas fa-circle me-1"></i>{{ auth_code.status_display }}
                                                        </span>
                                                    {% endif %}
                                                {% else %}
                                                    {% if auth_code.is_online is None %}
                                                        <!-- 其他类型显示自动登录按钮 -->
                                                        <button class="btn btn-sm btn-outline-primary auto-login-btn" 
                                                                onclick="autoLogin('{{ connection.pk }}', '{{ auth_code.pk }}', {{ forloop.counter }})"
                                                                title="自动登录" data-bs-toggle="tooltip"
                                                                id="auto-login-btn-{{ forloop.counter }}">
                                                            <i class="fas fa-sign-in-alt me-1"></i>自动登录
                                                        </button>
                                                    {% else %}
                                                        <span class="wechat-status status-{{ auth_code.status_class }}" id="status-{{ forloop.counter }}">
                                                            <i class="fas fa-circle me-1"></i>{{ auth_code.status_display }}
                                                        </span>
                                                    {% endif %}
                                                {% endif %}
                                            </td>
                                            <td class="align-middle">
                                                <div class="query-time">
                                                    <i class="fas fa-clock me-1"></i>
                                                    <span id="time-{{ forloop.counter }}">{{ auth_code.updated_at|date:"m-d H:i" }}</span>
                                                </div>
                                            </td>
                                            <td class="align-middle text-center">
                                                <div class="btn-group" role="group">
                                                    {% if connection.connection_type in 'wechatx,wechatx-861' %}
                                                        <!-- WeChat-X类型显示对话按钮 -->
                                                        <a href="{% url 'wechat_chat' connection.pk auth_code.pk %}" 
                                                           class="btn btn-outline-info btn-sm wechat-action-btn"
                                                           title="进入对话" data-bs-toggle="tooltip">
                                                            <i class="fas fa-comments"></i>
                                                        </a>
                                                    {% endif %}
                                                    <button class="btn btn-outline-primary btn-sm wechat-action-btn" 
                                                            onclick="queryWechatInfo('{{ auth_code.code }}', {{ forloop.counter }})"
                                                            title="查询信息" data-bs-toggle="tooltip"
                                                            id="query-btn-{{ forloop.counter }}">
                                                        <i class="fas fa-search"></i>
                                                    </button>
                                                    <button class="btn btn-outline-success btn-sm wechat-action-btn" 
                                                            onclick="refreshSingleWechat('{{ auth_code.code }}', {{ forloop.counter }})"
                                                            title="刷新信息" data-bs-toggle="tooltip"
                                                            id="refresh-btn-{{ forloop.counter }}">
                                                        <i class="fas fa-sync"></i>
                                                    </button>
                                                    <button class="btn btn-outline-warning btn-sm wechat-action-btn" 
                                                            onclick="editWechatRemark('{{ auth_code.code }}', {{ forloop.counter }})"
                                                            title="编辑备注" data-bs-toggle="tooltip">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger btn-sm wechat-action-btn" 
                                                            onclick="deleteWechatAccount('{{ auth_code.code }}', {{ forloop.counter }})"
                                                            title="删除账号" data-bs-toggle="tooltip">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="wechat-empty-state" id="emptyState">
                                <div class="empty-content">
                                    <div class="empty-icon">
                                        <i class="fab fa-weixin"></i>
                                    </div>
                                    <h4 class="text-muted mb-3">暂无微信账号</h4>
                                    <p class="text-muted mb-4">您还没有添加任何微信账号，点击下方按钮开始添加</p>
                                    <button class="btn btn-success btn-lg shadow-sm" onclick="addWechatAccount('{{ connection.pk }}')">
                                        <i class="fas fa-plus me-2"></i>添加第一个微信账号
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- 加载状态 -->
                    <div id="loadingState" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">正在刷新微信信息...</p>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- 添加微信账号模态框 -->
<div class="modal fade" id="addWechatModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加微信账号</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addWechatForm">
                    <div class="mb-3">
                        <label for="wechatCode" class="form-label">微信ID</label>
                        <input type="text" class="form-control" id="wechatCode" required 
                               placeholder="wxid_xxxxxxxxxx">
                        <div class="form-text">请输入有效的微信ID或授权码</div>
                    </div>
                    <div class="mb-3">
                        <label for="wechatRemark" class="form-label">备注名称</label>
                        <input type="text" class="form-control" id="wechatRemark" 
                               placeholder="为这个微信账号设置一个备注名">
                        <div class="form-text">可选，便于识别不同的微信账号</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitWechatAccount()">添加</button>
            </div>
        </div>
    </div>
</div>

<script>

// 添加微信账号
function addWechatAccount(connectionId) {
    $('#addWechatModal').modal('show');
    $('#addWechatModal').data('connection-id', connectionId);
}

function submitWechatAccount() {
    const connectionId = $('#addWechatModal').data('connection-id');
    const wechatCode = $('#wechatCode').val().trim();
    const wechatRemark = $('#wechatRemark').val().trim();
    
    if (!wechatCode) {
        showMessage('请输入微信ID', 'warning');
        return;
    }
    
    $.ajax({
        url: '/dashboard/api/auth-codes/add/',
        method: 'POST',
        data: {
            'code': wechatCode,
            'connection': connectionId,
            'remark': wechatRemark,
            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.code === 200) {
                showMessage('微信账号添加成功，正在自动刷新账号信息...', 'success');
                $('#addWechatModal').modal('hide');
                
                // 自动刷新新添加的账号
                setTimeout(() => {
                    autoRefreshNewAccount(connectionId, wechatCode);
                }, 1000);
            } else {
                showMessage('添加失败：' + response.msg, 'danger');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON || {};
            showMessage('添加失败：' + (response.msg || '网络错误'), 'danger');
        }
    });
}

// 自动刷新新添加的账号
function autoRefreshNewAccount(connectionId, wechatCode) {
    showMessage('正在获取账号信息...', 'info');
    
    $.ajax({
        url: '/dashboard/api/wechat/refresh-single/',
        method: 'POST',
        data: {
            'wxid': wechatCode,
            'connection_id': connectionId,
            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.code === 200) {
                const data = response.data;
                let message = '账号信息获取成功！';
                
                if (data.new_nickname) {
                    message += ` 昵称：${data.new_nickname}`;
                }
                if (data.status_display) {
                    message += ` 状态：${data.status_display}`;
                }
                
                showMessage(message, 'success');
                
                // 延迟刷新页面以显示完整信息
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showMessage('获取账号信息失败：' + response.msg + '，请手动刷新', 'warning');
                // 即使失败也刷新页面，至少显示添加的账号
                setTimeout(() => {
                    location.reload();
                }, 2000);
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON || {};
            showMessage('获取账号信息失败：' + (response.msg || '网络错误') + '，请手动刷新', 'warning');
            // 即使失败也刷新页面，至少显示添加的账号
            setTimeout(() => {
                location.reload();
            }, 2000);
        }
    });
}

// 刷新所有微信信息
function refreshWechatInfo() {
    const btn = $('#refreshBtn');
    const originalHtml = btn.html();
    
    btn.html('<i class="fas fa-spinner fa-spin me-1"></i>刷新中...');
    btn.prop('disabled', true);
    
    // 显示加载状态
    $('#wechatTableContainer').hide();
    $('#loadingState').show();
    
    $.ajax({
        url: '/dashboard/api/wechat/refresh-info/',
        method: 'POST',
        data: {
            'connection_id': '{{ connection.pk }}',
            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            $('#loadingState').hide();
            $('#wechatTableContainer').show();
            btn.html(originalHtml);
            btn.prop('disabled', false);
            
            if (response.code === 200) {
                showMessage(response.msg, 'success');
                
                // 显示失败的结果
                if (response.data.failed_results.length > 0) {
                    let failedMsg = '部分微信账号刷新失败：\n';
                    response.data.failed_results.forEach(function(failed) {
                        failedMsg += `${failed.wxid}: ${failed.error}\n`;
                    });
                    console.warn(failedMsg);
                }
                
                // 刷新页面以显示最新数据
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showMessage(response.msg || '刷新失败', 'danger');
            }
        },
        error: function(xhr, status, error) {
            $('#loadingState').hide();
            $('#wechatTableContainer').show();
            btn.html(originalHtml);
            btn.prop('disabled', false);
            showMessage('网络请求失败: ' + error, 'danger');
        }
    });
}

// 查询单个微信信息
function queryWechatInfo(wxid, rowIndex, showMsg = true) {
    const statusBadge = $(`#status-${rowIndex}`);
    const timeSpan = $(`#time-${rowIndex}`);
    const nicknameDiv = $(`#nickname-${rowIndex}`);
    const queryBtn = $(`#query-btn-${rowIndex}`);
    
    // 更新状态为查询中
    statusBadge.removeClass('bg-success bg-danger bg-warning')
               .addClass('bg-info')
               .html('<i class="fas fa-spinner fa-spin me-1"></i>查询中');
    
    queryBtn.prop('disabled', true);
    
    $.ajax({
        url: '/dashboard/api/wechat/query-info/',
        method: 'POST',
        data: {
            'wxid': wxid,
            'connection_id': '{{ connection.pk }}',
            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            const now = new Date();
            const timeStr = now.toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            if (response.code === 200) {
                const data = response.data;
                
                // 更新状态为正常
                statusBadge.removeClass('bg-info bg-danger bg-warning')
                           .addClass('bg-success')
                           .html('<i class="fas fa-circle me-1"></i>正常');
                
                // 显示详细信息对话框
                if (showMsg) {
                    showWechatInfoModal(data);
                    showMessage('查询成功', 'success');
                }
            } else {
                statusBadge.removeClass('bg-info bg-success bg-warning')
                           .addClass('bg-danger')
                           .html('<i class="fas fa-times me-1"></i>异常');
                
                if (showMsg) {
                    showMessage(response.msg || '查询失败，请检查微信状态', 'warning');
                }
            }
            
            timeSpan.text(timeStr);
            queryBtn.prop('disabled', false);
        },
        error: function(xhr, status, error) {
            const now = new Date();
            const timeStr = now.toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            statusBadge.removeClass('bg-info bg-success bg-warning')
                       .addClass('bg-danger')
                       .html('<i class="fas fa-times me-1"></i>异常');
            
            timeSpan.text(timeStr);
            queryBtn.prop('disabled', false);
            
            if (showMsg) {
                showMessage('网络请求失败: ' + error, 'danger');
            }
        }
    });
}

// 刷新单个微信
function refreshSingleWechat(wxid, rowIndex) {
    const statusBadge = $(`#status-${rowIndex}`);
    const timeSpan = $(`#time-${rowIndex}`);
    const nicknameDiv = $(`#nickname-${rowIndex}`);
    const avatarDiv = $(`#avatar-${rowIndex}`);
    const refreshBtn = $(`#refresh-btn-${rowIndex}`);
    
    // 更新状态为刷新中
    statusBadge.removeClass('status-online status-offline')
               .addClass('status-refreshing')
               .html('<i class="fas fa-spinner fa-spin me-1"></i>刷新中');
    
    refreshBtn.prop('disabled', true);
    
    $.ajax({
        url: '/dashboard/api/wechat/refresh-single/',
        method: 'POST',
        data: {
            'wxid': wxid,
            'connection_id': '{{ connection.pk }}',
            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            const now = new Date();
            const timeStr = now.toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            if (response.code === 200) {
                const data = response.data;
                
                // 检查是否从未知状态变为已知状态
                const statusTd = statusBadge.parent();
                const hasAutoLoginBtn = statusTd.find('.auto-login-btn').length > 0;
                
                if (hasAutoLoginBtn && data.is_online !== null) {
                    // 从自动登录按钮替换为状态徽章
                    statusTd.html(`
                        <span class="wechat-status status-${data.status_class}" id="status-${rowIndex}">
                            <i class="fas fa-circle me-1"></i>${data.status_display}
                        </span>
                    `);
                } else if (!hasAutoLoginBtn) {
                    // 更新现有状态徽章
                    statusBadge.removeClass('status-refreshing status-online status-offline status-success status-danger status-secondary')
                               .addClass(`status-${data.status_class}`)
                               .html(`<i class="fas fa-circle me-1"></i>${data.status_display}`);
                }
                
                // 更新昵称
                if (data.new_nickname) {
                    nicknameDiv.text(data.new_nickname);
                }
                
                // 更新头像
                if (data.avatar_url) {
                    console.log('更新头像:', data.avatar_url);
                    avatarDiv.html(`<img src="${data.avatar_url}" alt="头像" class="wechat-avatar-img">`);
                } else {
                    console.log('未获取到头像URL');
                }
                
                // 更新时间
                timeSpan.text(timeStr);
                
                // 构建成功消息
                let message = '刷新成功！';
                const changes = [];
                if (data.new_nickname !== data.old_nickname) {
                    changes.push(`昵称已从"${data.old_nickname || '未知'}"更新为"${data.new_nickname}"`);
                }
                if (data.status_updated) {
                    changes.push(`状态已更新为"${data.status_display}"`);
                }
                if (changes.length > 0) {
                    message += changes.join('，');
                } else {
                    message += '信息无变化';
                }
                
                showMessage(message, 'success');
                
                // 如果有状态更新或从未知变为已知，延迟刷新页面以显示最新数据
                if (data.status_updated || data.new_nickname !== data.old_nickname || hasAutoLoginBtn) {
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                }
            } else {
                statusBadge.removeClass('status-refreshing status-success')
                           .addClass('status-offline')
                           .html('<i class="fas fa-times me-1"></i>异常');
                
                showMessage(response.msg || '刷新失败', 'warning');
            }
            
            timeSpan.text(timeStr);
            refreshBtn.prop('disabled', false);
        },
        error: function(xhr, status, error) {
            const now = new Date();
            const timeStr = now.toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            statusBadge.removeClass('status-refreshing status-online')
                       .addClass('status-offline')
                       .html('<i class="fas fa-times me-1"></i>异常');
            
            timeSpan.text(timeStr);
            refreshBtn.prop('disabled', false);
            
            let errorMsg = '网络请求失败';
            if (xhr.responseJSON && xhr.responseJSON.msg) {
                errorMsg = xhr.responseJSON.msg;
            } else if (error) {
                errorMsg += ': ' + error;
            }
            showMessage(errorMsg, 'danger');
        }
    });
}

// 自动登录
function autoLogin(connectionId, codeId, rowIndex) {
    const btn = $(`#auto-login-btn-${rowIndex}`);
    const originalHtml = btn.html();
    
    // 更新按钮状态
    btn.html('<i class="fas fa-spinner fa-spin me-1"></i>登录中...');
    btn.prop('disabled', true);
    
    $.ajax({
        url: `/dashboard/wechat-login/${connectionId}/auto-login/${codeId}/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.code === 200) {
                // 自动登录成功，更新状态为在线
                const statusTd = btn.parent();
                const data = response.data || {};
                
                // 使用返回的状态信息或默认为在线
                const statusClass = data.is_online ? 'status-success' : 'status-danger';
                const statusText = data.is_online ? '在线' : '离线';
                
                statusTd.html(`
                    <span class="wechat-status ${statusClass}" id="status-${rowIndex}">
                        <i class="fas fa-circle me-1"></i>${statusText}
                    </span>
                `);
                
                let message = '自动登录成功！';
                if (data.status_updated) {
                    message += ` 状态已更新为${statusText}`;
                }
                showMessage(message, 'success');
                
                // 延迟刷新页面以显示最新数据
                setTimeout(() => {
                    location.reload();
                }, 1500);
                
            } else if (response.code === 202) {
                // 需要扫码登录
                showMessage('需要扫码登录，请前往微信登录页面', 'info');
                // 可以选择跳转到微信登录页面
                setTimeout(() => {
                    window.open('/dashboard/wechat-login/', '_blank');
                }, 1000);
                
            } else {
                showMessage('自动登录失败：' + response.msg, 'warning');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON || {};
            showMessage('自动登录失败：' + (response.msg || '网络错误'), 'danger');
        },
        complete: function() {
            // 恢复按钮状态
            btn.html(originalHtml);
            btn.prop('disabled', false);
        }
    });
}

// 删除微信账号
function deleteWechatAccount(wxid, rowIndex) {
    if (!confirm('确定要删除这个微信账号吗？')) {
        return;
    }
    
    $.ajax({
        url: '/dashboard/api/auth-codes/delete/',
        method: 'POST',
        data: {
            'code': wxid,
            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.code === 200) {
                showMessage('微信账号删除成功', 'success');
                $(`#row-${rowIndex}`).fadeOut(300, function() {
                    $(this).remove();
                    updateWechatCount();
                });
            } else {
                showMessage('删除失败：' + response.msg, 'warning');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON || {};
            showMessage('删除失败：' + (response.msg || '网络错误'), 'danger');
        }
    });
}

// 更新微信账号数量
function updateWechatCount() {
    const count = $('#wechatTableBody tr').length;
    $('#wechatCount').text(count);
    
    if (count === 0) {
        $('#wechatTableContainer').html(`
            <div class="text-center py-4" id="emptyState">
                <i class="fab fa-weixin fa-4x text-muted mb-3"></i>
                <h5 class="text-muted">暂无微信账号</h5>
                <p class="text-muted">请添加微信账号以开始使用</p>
                <button class="btn btn-primary" onclick="addWechatAccount('{{ connection.pk }}')">
                    <i class="fas fa-plus me-2"></i>添加微信账号
                </button>
            </div>
        `);
    }
}

// 显示微信信息详情对话框
function showWechatInfoModal(data) {
    // 获取调试配置
    const debugEnabled = {% if debug_enabled %}true{% else %}false{% endif %};
    
    // 构建头像HTML - 检查多个可能的头像字段
    console.log('完整数据:', data); // 调试：输出完整数据
    console.log('bigHeadImgUrl:', data.bigHeadImgUrl);
    console.log('smallHeadImgUrl:', data.smallHeadImgUrl);
    
    // 检查多种可能的头像字段名
    let avatarUrl = data.bigHeadImgUrl || data.smallHeadImgUrl || 
                   data.BigHeadImgUrl || data.SmallHeadImgUrl ||
                   data.headImgUrl || data.HeadImgUrl || 
                   data.avatar || data.avatarUrl || '';
    
    console.log('最终头像URL:', avatarUrl); // 调试日志
    
    const avatarHtml = avatarUrl && avatarUrl.trim() ? 
        `<img src="${avatarUrl}" alt="头像" class="wechat-profile-avatar" 
              onerror="console.log('头像加载失败:', this.src); this.style.display='none'; this.nextElementSibling.style.display='flex';"
              onload="console.log('头像加载成功:', this.src);">
         <div class="wechat-profile-avatar-placeholder" style="display: none;">
            <i class="fab fa-weixin"></i>
         </div>` :
        `<div class="wechat-profile-avatar-placeholder">
            <i class="fab fa-weixin"></i>
        </div>`;
    
    // 构建详细信息区域
    const detailsHtml = debugEnabled ? `
        <div class="col-12 mt-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-gradient-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-code me-2"></i>调试信息
                        <small class="opacity-75 ms-2">（仅在调试模式下显示）</small>
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="debug-info-container">
                        <pre class="debug-json">${JSON.stringify(data.full_result, null, 2)}</pre>
                    </div>
                </div>
            </div>
        </div>
    ` : '';
    
    const modalHtml = `
        <div class="modal fade" id="wechatInfoModal" tabindex="-1" aria-labelledby="wechatInfoModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content wechat-profile-modal">
                    <div class="modal-header bg-gradient-wechat text-white border-0">
                        <h5 class="modal-title d-flex align-items-center" id="wechatInfoModalLabel">
                            <div class="modal-icon-wrapper me-3">
                                <i class="fab fa-weixin"></i>
                            </div>
                            <div>
                                <div class="modal-title-main">微信个人资料</div>
                                <small class="modal-title-sub opacity-75">WeChat Profile Information</small>
                            </div>
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="row">
                            <!-- 头像和基本信息 -->
                            <div class="col-lg-4">
                                <div class="profile-card text-center">
                                    <div class="profile-avatar-container mb-4">
                                        ${avatarHtml}
                                        <div class="profile-status-indicator ${data.isOnline ? 'online' : 'offline'}"></div>
                                    </div>
                                    <h4 class="profile-nickname mb-2">${data.nickName || '未设置昵称'}</h4>
                                    <p class="profile-wxid text-muted mb-3">
                                        <i class="fas fa-id-card me-2"></i>${data.wxid || '未知'}
                                    </p>
                                    <div class="profile-stats">
                                        <div class="stat-item">
                                            <div class="stat-value">${data.isOnline ? '在线' : '离线'}</div>
                                            <div class="stat-label">状态</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 详细信息 -->
                            <div class="col-lg-8">
                                <div class="info-sections">
                                    <!-- 个人信息 -->
                                    <div class="info-section mb-4">
                                        <div class="section-header">
                                            <i class="fas fa-user-circle text-primary me-2"></i>
                                            <h6 class="mb-0">个人信息</h6>
                                        </div>
                                        <div class="section-content">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <div class="info-item">
                                                        <label class="info-label">
                                                            <i class="fas fa-signature me-2"></i>用户名
                                                        </label>
                                                        <div class="info-value">${data.userName || '未设置'}</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="info-item">
                                                        <label class="info-label">
                                                            <i class="fas fa-mobile-alt me-2"></i>绑定手机
                                                        </label>
                                                        <div class="info-value">${data.bindMobile || '未绑定'}</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="info-item">
                                                        <label class="info-label">
                                                            <i class="fas fa-tag me-2"></i>备注名称
                                                        </label>
                                                        <div class="info-value">${data.remark || '无备注'}</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="info-item">
                                                        <label class="info-label">
                                                            <i class="fas fa-clock me-2"></i>查询时间
                                                        </label>
                                                        <div class="info-value">${new Date().toLocaleString()}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 账号状态 -->
                                    <div class="info-section">
                                        <div class="section-header">
                                            <i class="fas fa-shield-alt text-success me-2"></i>
                                            <h6 class="mb-0">账号状态</h6>
                                        </div>
                                        <div class="section-content">
                                            <div class="status-grid">
                                                <div class="status-item">
                                                    <div class="status-icon ${data.isOnline ? 'text-success' : 'text-danger'}">
                                                        <i class="fas fa-circle"></i>
                                                    </div>
                                                    <div class="status-info">
                                                        <div class="status-title">在线状态</div>
                                                        <div class="status-desc">${data.isOnline ? '账号当前在线' : '账号当前离线'}</div>
                                                    </div>
                                                </div>
                                                <div class="status-item">
                                                    <div class="status-icon text-info">
                                                        <i class="fas fa-database"></i>
                                                    </div>
                                                    <div class="status-info">
                                                        <div class="status-title">数据完整性</div>
                                                        <div class="status-desc">${data.nickName && data.bigHeadImgUrl ? '信息完整' : '信息不完整'}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            ${detailsHtml}
                        </div>
                    </div>
                    <div class="modal-footer border-0 bg-light">
                        <div class="d-flex justify-content-between w-100">
                            <div class="footer-info text-muted small">
                                <i class="fas fa-info-circle me-1"></i>
                                数据来源于微信协议接口，实时更新
                            </div>
                            <div class="footer-actions">
                                <button type="button" class="btn btn-outline-success me-2" onclick="refreshSingleWechat('${data.wxid}')" data-bs-dismiss="modal">
                                    <i class="fas fa-sync me-1"></i>刷新信息
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i>关闭
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // 移除已存在的对话框
    $('#wechatInfoModal').remove();
    
    // 添加新对话框到页面
    $('body').append(modalHtml);
    
    // 显示对话框
    $('#wechatInfoModal').modal('show');
    
    // 对话框关闭后移除DOM元素
    $('#wechatInfoModal').on('hidden.bs.modal', function() {
        $(this).remove();
    });
}

// 清空模态框
$('#addWechatModal').on('hidden.bs.modal', function() {
    $('#addWechatForm')[0].reset();
});

// 生成授权码 (WeCharPadPro)
function generateAuthCode(connectionId) {
    const days = prompt('请输入授权码有效天数（正整数）:', '30');
    if (!days || !Number.isInteger(Number(days)) || Number(days) <= 0) {
        showMessage('请输入有效的天数', 'warning');
        return;
    }
    
    showMessage('正在生成授权码...', 'info');
    
    $.ajax({
        url: `/dashboard/api/connections/${connectionId}/generate-auth-code/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
            'Content-Type': 'application/json'
        },
        data: JSON.stringify({
            days: parseInt(days)
        }),
        success: function(response) {
            if (response.code === 200) {
                const authCodes = response.data.auth_codes || [];
                if (authCodes.length > 0) {
                    let message = '🎉 授权码生成成功！\n';
                    authCodes.forEach((code, index) => {
                        message += `✅ 授权码 ${index + 1}: ${code}\n`;
                    });
                    alert(message);
                    
                    // 询问是否添加备注并保存
                    authCodes.forEach(code => {
                        const remark = prompt(`为授权码 ${code} 添加备注（可选）:`, '');
                        if (remark !== null) {
                            // 这里可以调用添加微信账号的API，将授权码作为微信ID添加
                            addWechatAccountWithCode(connectionId, code, remark);
                        }
                    });
                } else {
                    showMessage('授权码生成成功，但未返回授权码信息', 'warning');
                }
            } else {
                showMessage('生成失败：' + (response.msg || '未知错误'), 'danger');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON || {};
            showMessage('生成失败：' + (response.msg || '网络错误'), 'danger');
        }
    });
}

// 添加带授权码的微信账号
function addWechatAccountWithCode(connectionId, code, remark) {
    $.ajax({
        url: `/dashboard/api/connections/${connectionId}/auth-codes/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
            'Content-Type': 'application/json'
        },
        data: JSON.stringify({
            code: code,
            remark: remark || code
        }),
        success: function(response) {
            if (response.code === 200) {
                showMessage(`授权码 ${code} 添加成功`, 'success');
                // 刷新页面显示新账号
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON || {};
            showMessage(`添加授权码 ${code} 失败：` + (response.msg || '网络错误'), 'danger');
        }
    });
}

// 登录Pro (WeCharPadPro)
function loginPro(connectionId, authCode, rowIndex) {
    showMessage('正在获取登录二维码...', 'info');
    
    $.ajax({
        url: `/dashboard/api/connections/${connectionId}/login-pro/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
            'Content-Type': 'application/json'
        },
        data: JSON.stringify({
            auth_code: authCode
        }),
        success: function(response) {
            if (response.code === 200) {
                const data = response.data;
                if (data.qr_code_url) {
                    showQRCodeModal(data.qr_code_url, connectionId, authCode, rowIndex);
                } else {
                    showMessage('获取二维码失败：无有效二维码URL', 'danger');
                }
            } else {
                showMessage('获取二维码失败：' + (response.msg || '未知错误'), 'danger');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON || {};
            showMessage('获取二维码失败：' + (response.msg || '网络错误'), 'danger');
        }
    });
}

// 显示二维码登录对话框
function showQRCodeModal(qrCodeUrl, connectionId, authCode, rowIndex) {
    const modalHtml = `
        <div class="modal fade" id="qrLoginModal" tabindex="-1" aria-labelledby="qrLoginModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="qrLoginModalLabel">
                            <i class="fas fa-qrcode me-2"></i>扫码登录Pro
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <div id="qrCodeContainer" class="mb-3">
                            <div id="qrcode"></div>
                        </div>
                        <p class="text-muted mb-2">请使用微信扫描二维码进行Pro登录</p>
                        <p class="text-warning small">⏰ 100秒内有效</p>
                        <div id="loginStatus" class="mt-3">
                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span class="text-muted">等待扫码...</span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="handleProLoginCancel()">
                            <i class="fas fa-times me-1"></i>取消
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // 移除已存在的对话框
    $('#qrLoginModal').remove();
    
    // 添加新对话框到页面
    $('body').append(modalHtml);
    
    // 生成二维码
    $('#qrcode').qrcode({
        text: qrCodeUrl,
        width: 240,
        height: 240
    });
    
    // 显示对话框
    $('#qrLoginModal').modal('show');
    
    // 开始检查登录状态
    checkLoginStatus(connectionId, authCode, rowIndex);
    
    // 对话框关闭后移除DOM元素
    $('#qrLoginModal').on('hidden.bs.modal', function() {
        clearInterval(window.loginStatusInterval);
        $(this).remove();
    });
    
    // 对话框即将关闭时停止状态检查
    $('#qrLoginModal').on('hide.bs.modal', function() {
        clearInterval(window.loginStatusInterval);
    });
}

// 处理Pro登录取消
function handleProLoginCancel() {
    clearInterval(window.loginStatusInterval);
    showMessage('Pro登录已取消', 'info');
}

// 检查登录状态
function checkLoginStatus(connectionId, authCode, rowIndex) {
    let checkCount = 0;
    const maxChecks = 50; // 100秒，每2秒检查一次
    
    window.loginStatusInterval = setInterval(() => {
        checkCount++;
        
        if (checkCount > maxChecks) {
            $('#loginStatus').html('<span class="text-danger">⏰ 二维码已过期，未登录</span>');
            clearInterval(window.loginStatusInterval);
            setTimeout(() => {
                $('#qrLoginModal').modal('hide');
            }, 2000);
            return;
        }
        
        $.ajax({
            url: `/dashboard/api/connections/${connectionId}/check-login-status/`,
            method: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'Content-Type': 'application/json'
            },
            data: JSON.stringify({
                auth_code: authCode
            }),
            success: function(response) {
                if (response.code === 200) {
                    const data = response.data;
                    if (data.login_state === 1) {
                        // 登录成功
                        $('#loginStatus').html('<span class="text-success">🎉 登录成功！</span>');
                        clearInterval(window.loginStatusInterval);
                        
                        // 显示登录结果
                        const loginMsg = data.loginErrMsg || '登录成功！';
                        const loginTime = data.loginTime || '未知';
                        const expiryTime = data.expiryTime || '未知';
                        const onlineTime = data.onlineTime || '未知';
                        const totalOnline = data.totalOnline || '未知';
                        
                        // 格式化登录成功消息，参考原始协议核心格式
                        const successMessage = `🎉 Pro登录成功！
══════════════════
✅ 状态: ${loginMsg}
🕒 登录时间: ${loginTime}
📅 授权到期: ${expiryTime}
⏱️ 本次在线: ${onlineTime}
📊 总计在线: ${totalOnline}
══════════════════`;
                        
                        showMessage(successMessage, 'success');
                        
                        setTimeout(() => {
                            $('#qrLoginModal').modal('hide');
                            // 刷新页面状态
                            refreshSingleWechat(authCode, rowIndex);
                        }, 2000);
                    }
                }
            },
            error: function() {
                // 忽略检查状态的错误，继续检查
            }
        });
    }, 2000);
}
</script>

<style>
/* 微信管理表格样式 */
#wechatTable {
    font-size: 0.9rem;
}

#wechatTable th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    color: #495057;
}

#wechatTable td {
    vertical-align: middle;
    padding: 0.75rem 0.5rem;
}

/* 状态徽章动画 */
.status-badge {
    transition: all 0.3s ease;
}

.status-badge:hover {
    transform: scale(1.05);
}

/* 昵称文本样式 */
.nickname-text {
    font-size: 0.95rem;
    color: #2c3e50;
}

/* 微信图标样式 */
.fab.fa-weixin {
    color: #07c160 !important;
}

/* 操作按钮组样式 */
.btn-group-sm .btn {
    padding: 0.25rem 0.4rem;
    font-size: 0.8rem;
}

/* 加载状态样式 */
#loadingState {
    background-color: rgba(255, 255, 255, 0.9);
}

/* 表格行悬停效果 */
#wechatTable tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease;
}

/* 序号列样式 */
#wechatTable tbody td:first-child {
    font-weight: bold;
    color: #6c757d;
    text-align: center;
}

/* 空状态样式 */
#emptyState {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 10px;
    margin: 1rem 0;
}

/* 刷新按钮动画 */
#refreshBtn .fa-sync {
    transition: transform 0.3s ease;
}

#refreshBtn:hover .fa-sync {
    transform: rotate(180deg);
}

/* 微信表格现代化样式 */
.wechat-table {
    border-collapse: separate;
    border-spacing: 0;
}

.wechat-table thead th {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    font-weight: 600;
    padding: 1rem;
    position: sticky;
    top: 0;
    z-index: 10;
}

.wechat-row {
    transition: all 0.2s ease;
    border-bottom: 1px solid #f1f3f4;
}

.wechat-row:hover {
    background-color: #f8f9fa;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.wechat-table td {
    padding: 1.25rem 1rem;
    vertical-align: middle;
    border: none;
}

/* 微信头像样式 */
.wechat-avatar {
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #07c160 0%, #00ae42 100%);
    border-radius: 12px;
    color: white;
    font-size: 20px;
    box-shadow: 0 2px 8px rgba(7, 193, 96, 0.3);
    overflow: hidden;
    position: relative;
}

.wechat-avatar-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 12px;
}

/* 序号样式 */
.wechat-number {
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    color: white;
    font-weight: 600;
    font-size: 14px;
    box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
}

/* 微信昵称样式 */
.wechat-nickname {
    font-weight: 600;
    font-size: 1rem;
    color: #2c3e50;
    margin-bottom: 0.25rem;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* 微信ID样式 */
.wechat-id {
    font-size: 0.875rem;
    color: #6c757d;
    display: flex;
    align-items: center;
}

.wechat-id code {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    padding: 0.2rem 0.4rem;
    font-size: 0.8rem;
    color: #495057;
}

/* 状态徽章样式 */
.wechat-status {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 500;
    font-size: 0.875rem;
    display: inline-flex;
    align-items: center;
}

.status-online {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
}

.status-offline {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
    box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
}

.status-refreshing {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    color: white;
    box-shadow: 0 2px 4px rgba(23, 162, 184, 0.3);
}

.status-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
}

.status-danger {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
    box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
}

.status-secondary {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
    box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
}

/* 自动登录按钮样式 */
.auto-login-btn {
    border-radius: 15px;
    padding: 0.4rem 0.8rem;
    font-weight: 500;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    border-width: 1.5px;
}

.auto-login-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,123,255,0.3);
}

/* 查询时间样式 */
.query-time {
    color: #6c757d;
    font-size: 0.875rem;
    display: flex;
    align-items: center;
}

/* 操作按钮样式 */
.wechat-action-btn {
    border-radius: 8px;
    padding: 0.5rem 0.75rem;
    margin: 0 2px;
    transition: all 0.2s ease;
    border-width: 1.5px;
}

.wechat-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

/* 渐变背景 */
.bg-gradient-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

/* 微信空状态样式 */
.wechat-empty-state {
    padding: 4rem 2rem;
    text-align: center;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
}

.wechat-empty-state .empty-content {
    max-width: 400px;
    margin: 0 auto;
}

.wechat-empty-state .empty-icon {
    width: 120px;
    height: 120px;
    margin: 0 auto 2rem;
    background: linear-gradient(135deg, #07c160 0%, #00ae42 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 25px rgba(7, 193, 96, 0.3);
}

.wechat-empty-state .empty-icon i {
    font-size: 3rem;
    color: white;
}

/* 加载动画 */
.wechat-action-btn .fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* 响应式调整 */
@media (max-width: 768px) {
    .wechat-table {
        font-size: 0.875rem;
    }
    
    .wechat-table td {
        padding: 0.75rem 0.5rem;
    }
    
    .wechat-nickname {
        max-width: 120px;
    }
    
    .btn-group {
        flex-direction: column;
    }
    
    .wechat-action-btn {
        margin: 2px 0;
        width: 100%;
    }
    
    .wechat-avatar {
        width: 35px;
        height: 35px;
        font-size: 16px;
    }
    
    .wechat-number {
        width: 28px;
        height: 28px;
        font-size: 12px;
    }
}

/* 连接信息概览样式 */
.info-item {
    margin-bottom: 1rem;
}

.info-label {
    display: flex;
    align-items: center;
    font-size: 0.875rem;
    font-weight: 500;
    color: #6c757d;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-value {
    font-size: 1rem;
    font-weight: 500;
    color: #2c3e50;
    display: flex;
    align-items: center;
}

/* 统计卡片样式 */
.stats-container {
    height: 100%;
    display: flex;
    align-items: center;
}

.stat-card {
    transition: all 0.3s ease;
    border: 1px solid rgba(0,0,0,0.05);
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
}

.stat-icon {
    opacity: 0.8;
}

.stat-number {
    font-size: 2rem;
    line-height: 1;
    margin: 0.5rem 0;
}

.stat-label {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0;
}

/* 连接信息概览卡片 */
.card.border-0.shadow-sm {
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08) !important;
    transition: all 0.3s ease;
}

.card.border-0.shadow-sm:hover {
    transform: translateY(-2px);
    box-shadow: 0 15px 40px rgba(0,0,0,0.12) !important;
}

/* 代码样式优化 */
code.bg-light {
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    color: #e83e8c;
    background-color: #f8f9fa !important;
    border: 1px solid #e9ecef;
    border-radius: 6px;
}

/* 徽章样式增强 */
.badge.fs-6 {
    font-size: 0.875rem !important;
    padding: 0.5rem 0.75rem;
    border-radius: 20px;
}

/* 响应式调整 */
@media (max-width: 768px) {
    #wechatTable {
        font-size: 0.8rem;
    }
    
    #wechatTable th,
    #wechatTable td {
        padding: 0.5rem 0.25rem;
    }
    
    .btn-group-sm .btn {
        padding: 0.2rem 0.3rem;
        font-size: 0.7rem;
    }
    
    .stat-number {
        font-size: 1.5rem;
    }
    
    .stat-card {
        padding: 1rem !important;
    }
    
    .info-value {
        font-size: 0.875rem;
    }
}

@media (max-width: 992px) {
    .stats-container {
        margin-top: 2rem;
    }
    
    .stat-card {
        margin-bottom: 1rem;
    }
}

/* 微信个人资料模态框样式 */
.wechat-profile-modal {
    border: none;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
}

.bg-gradient-wechat {
    background: linear-gradient(135deg, #07c160 0%, #00ae42 100%);
}

.modal-icon-wrapper {
    width: 50px;
    height: 50px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

.modal-title-main {
    font-size: 1.25rem;
    font-weight: 600;
}

.modal-title-sub {
    font-size: 0.875rem;
    font-weight: 400;
}

/* 个人资料卡片 */
.profile-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 20px;
    padding: 2rem;
    height: 100%;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
}

.profile-avatar-container {
    position: relative;
    display: inline-block;
}

.wechat-profile-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid #ffffff;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.wechat-profile-avatar-placeholder {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: linear-gradient(135deg, #07c160 0%, #00ae42 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 48px;
    border: 4px solid #ffffff;
    box-shadow: 0 8px 25px rgba(7, 193, 96, 0.3);
}

.profile-status-indicator {
    position: absolute;
    bottom: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 3px solid #ffffff;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.profile-status-indicator.online {
    background: #28a745;
}

.profile-status-indicator.offline {
    background: #6c757d;
}

.profile-nickname {
    color: #2c3e50;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.profile-wxid {
    font-family: 'Courier New', monospace;
    background: #f8f9fa;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    border: 1px solid #e9ecef;
}

.profile-stats {
    margin-top: 2rem;
}

.stat-item {
    text-align: center;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #07c160;
    margin-bottom: 0.25rem;
}

.stat-label {
    font-size: 0.875rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* 信息区域 */
.info-sections {
    height: 100%;
}

.info-section {
    background: #ffffff;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    border: 1px solid #f1f3f4;
}

.section-header {
    display: flex;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #f8f9fa;
}

.section-header h6 {
    color: #2c3e50;
    font-weight: 600;
    margin: 0;
}

.section-content {
    margin: 0;
}

.info-item {
    margin-bottom: 1rem;
}

.info-label {
    display: flex;
    align-items: center;
    font-size: 0.875rem;
    font-weight: 500;
    color: #6c757d;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-value {
    font-size: 1rem;
    font-weight: 500;
    color: #2c3e50;
    padding: 0.75rem 1rem;
    background: #f8f9fa;
    border-radius: 10px;
    border: 1px solid #e9ecef;
    min-height: 45px;
    display: flex;
    align-items: center;
}

/* 状态网格 */
.status-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
}

.status-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 12px;
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
}

.status-item:hover {
    background: #ffffff;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.status-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    font-size: 16px;
}

.status-info {
    flex: 1;
}

.status-title {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.25rem;
}

.status-desc {
    font-size: 0.875rem;
    color: #6c757d;
}

/* 调试信息区域 */
.debug-info-container {
    max-height: 400px;
    overflow-y: auto;
    background: #1e1e1e;
    border-radius: 8px;
}

.debug-json {
    color: #d4d4d4;
    font-family: 'Courier New', monospace;
    font-size: 0.8rem;
    line-height: 1.4;
    margin: 0;
    padding: 1.5rem;
    background: transparent;
    border: none;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/* 自定义滚动条 */
.debug-info-container::-webkit-scrollbar {
    width: 8px;
}

.debug-info-container::-webkit-scrollbar-track {
    background: #2d2d2d;
    border-radius: 4px;
}

.debug-info-container::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 4px;
}

.debug-info-container::-webkit-scrollbar-thumb:hover {
    background: #777;
}

/* 模态框底部 */
.modal-footer.bg-light {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%) !important;
}

.footer-info {
    display: flex;
    align-items: center;
}

.footer-actions {
    display: flex;
    align-items: center;
}

/* 响应式调整 */
@media (max-width: 992px) {
    .wechat-profile-modal .modal-dialog {
        margin: 1rem;
    }
    
    .profile-card {
        margin-bottom: 2rem;
    }
    
    .wechat-profile-avatar,
    .wechat-profile-avatar-placeholder {
        width: 100px;
        height: 100px;
    }
    
    .wechat-profile-avatar-placeholder {
        font-size: 40px;
    }
    
    .modal-icon-wrapper {
        width: 40px;
        height: 40px;
        font-size: 20px;
    }
}

@media (max-width: 576px) {
    .wechat-profile-modal .modal-body {
        padding: 1.5rem;
    }
    
    .profile-card {
        padding: 1.5rem;
    }
    
    .info-section {
        padding: 1rem;
    }
    
    .modal-footer {
        flex-direction: column;
        gap: 1rem;
    }
    
    .footer-info,
    .footer-actions {
        width: 100%;
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<!-- QRCode.js 库 -->
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery.qrcode@1.0.3/jquery.qrcode.min.js"></script>
{% endblock %}
