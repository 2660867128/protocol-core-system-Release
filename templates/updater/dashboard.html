{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    /* æ›´æ–°è¿›åº¦åŠ¨ç”»æ ·å¼ */
    #updateProgressContainer {
        animation: slideInUp 0.5s ease-out;
    }
    
    @keyframes slideInUp {
        from {
            transform: translateY(30px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    .progress-bar {
        transition: width 0.3s ease;
    }
    
    #currentFile {
        transition: all 0.3s ease;
        border-left: 3px solid #007bff;
    }
    
    #operationLog {
        transition: all 0.3s ease;
    }
    
    .log-entry {
        animation: fadeInLeft 0.3s ease;
        padding: 2px 0;
    }
    
    @keyframes fadeInLeft {
        from {
            transform: translateX(-20px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    .spinner-border {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* æŒ‰é’®åŠ¨ç”» */
    .btn {
        transition: all 0.2s ease;
    }
    
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* è¿›åº¦æ¡åŠ¨ç”» */
    .progress-bar-animated {
        animation: progress-bar-stripes 1s linear infinite;
    }
    
    @keyframes progress-bar-stripes {
        0% {
            background-position: 1rem 0;
        }
        100% {
            background-position: 0 0;
        }
    }
        .update-card {
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .update-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .version-badge {
            font-size: 1.2rem;
            padding: 0.5rem 1rem;
        }
        
        .progress-container {
            display: none;
        }
        
        .changelog {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .status-badge {
            font-size: 0.9rem;
        }
        
        .update-history {
            max-height: 400px;
            overflow-y: auto;
        }
</style>
{% endblock %}

{% block content %}
<!-- é¡µé¢æ ‡é¢˜ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h3 mb-0">
                <i class="fas fa-sync-alt me-2 text-primary"></i>
                æ›´æ–°è®¾ç½®
            </h1>
            <div>
                <button class="btn btn-outline-primary me-2" onclick="checkUpdates()">
                    <i class="fas fa-search me-2"></i>æ£€æŸ¥æ›´æ–°
                </button>
                <button class="btn btn-success" onclick="executeGitHubUpdate()">
                    <i class="fab fa-github me-2"></i>ç«‹å³æ›´æ–°
                </button>
            </div>
        </div>
    </div>
</div>

<!-- GitHub æ›´æ–°ä¿¡æ¯å¡ç‰‡ -->
<div class="row mb-4" id="githubUpdateCard" style="display: none;">
    <div class="col-12">
        <div class="card update-card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fab fa-github me-2"></i>
                    GitHub æ›´æ–°å¯ç”¨
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6 class="mb-2">
                            <span class="badge bg-primary me-2" id="newVersionBadge">v1.0.0</span>
                            <small class="text-muted" id="updateAuthor">by Author</small>
                        </h6>
                        <p class="mb-2" id="updateMessage">æ›´æ–°æ¶ˆæ¯</p>
                        <small class="text-muted">
                            <i class="fas fa-calendar me-1"></i>
                            <span id="updateDate">æ›´æ–°æ—¶é—´</span>
                        </small>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-success" onclick="confirmGitHubUpdate()">
                            <i class="fas fa-download me-2"></i>ç«‹å³æ›´æ–°
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å½“å‰ç‰ˆæœ¬ä¿¡æ¯ -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card update-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="fas fa-info-circle text-info me-2"></i>
                            å½“å‰ç‰ˆæœ¬
                        </h5>
                        <span class="badge bg-primary version-badge">{{ current_version }}</span>
                        <p class="card-text mt-3 text-muted" id="currentVersionInfo">
                            {{ current_version_info }}
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card update-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-chart-line text-success me-2"></i>
                            ç³»ç»ŸçŠ¶æ€
                        </h5>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="text-success">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                    <p class="mb-0 mt-2 small">è¿è¡Œæ­£å¸¸</p>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="text-info">
                                    <i class="fas fa-database fa-2x"></i>
                                    <p class="mb-0 mt-2 small">æ•°æ®å®Œæ•´</p>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="text-warning">
                                    <i class="fas fa-shield-alt fa-2x"></i>
                                    <p class="mb-0 mt-2 small">å®‰å…¨é˜²æŠ¤</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ›´æ–°è¿›åº¦ -->
        <div class="row mb-4 progress-container" id="progressContainer">
            <div class="col-12">
                <div class="card update-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-download text-primary me-2"></i>
                            æ›´æ–°è¿›åº¦
                        </h5>
                        <div class="progress mb-3" style="height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="updateProgress" role="progressbar" style="width: 0%">
                                0%
                            </div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span id="updateStatus">å‡†å¤‡ä¸­...</span>
                            <button class="btn btn-sm btn-outline-danger" onclick="cancelUpdate()">
                                <i class="fas fa-times me-1"></i>å–æ¶ˆæ›´æ–°
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- å¯ç”¨ç‰ˆæœ¬ -->
            <div class="col-md-8">
                <div class="card update-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-list text-primary me-2"></i>
                            å¯ç”¨ç‰ˆæœ¬
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if available_versions %}
                            {% for version in available_versions %}
                            <div class="border rounded p-3 mb-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-2">
                                            <span class="badge bg-{% if version.is_stable %}success{% else %}warning{% endif %} me-2">
                                                v{{ version.version }}
                                            </span>
                                            {% if version.is_stable %}
                                                <small class="text-success">ç¨³å®šç‰ˆ</small>
                                            {% else %}
                                                <small class="text-warning">æµ‹è¯•ç‰ˆ</small>
                                            {% endif %}
                                        </h6>
                                        <p class="text-muted small mb-2">
                                            <i class="fas fa-calendar me-1"></i>
                                            å‘å¸ƒæ—¶é—´: {{ version.release_date|date:"Y-m-d H:i" }}
                                        </p>
                                        <p class="text-muted small mb-2">
                                            <i class="fas fa-file-archive me-1"></i>
                                            æ–‡ä»¶å¤§å°: {{ version.file_size|filesizeformat }}
                                        </p>
                                        {% if version.changelog %}
                                        <div class="changelog">
                                            <strong>æ›´æ–°æ—¥å¿—:</strong><br>
                                            {{ version.changelog|linebreaksbr }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="ms-3">
                                        {% if version.version != current_version %}
                                        <button class="btn btn-primary btn-sm" 
                                                onclick="startUpdate('{{ version.version }}')">
                                            <i class="fas fa-download me-1"></i>
                                            æ›´æ–°åˆ°æ­¤ç‰ˆæœ¬
                                        </button>
                                        {% else %}
                                        <span class="badge bg-success">å½“å‰ç‰ˆæœ¬</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-4">
                                <i class="fab fa-github fa-3x text-muted mb-3"></i>
                                <p class="text-muted">ä½¿ç”¨ GitHub è‡ªåŠ¨æ›´æ–°è·å–æœ€æ–°ç‰ˆæœ¬</p>
                                <button class="btn btn-outline-primary me-2" onclick="checkUpdates()">
                                    <i class="fas fa-search me-2"></i>æ£€æŸ¥æ›´æ–°
                                </button>
                                <button class="btn btn-success" onclick="executeGitHubUpdate()">
                                    <i class="fab fa-github me-2"></i>ç«‹å³æ›´æ–°
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- å¤‡ä»½ç®¡ç† -->
            <div class="col-md-4">
                <div class="card update-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-archive text-warning me-2"></i>
                            å¤‡ä»½ç®¡ç†
                        </h5>
                    </div>
                    <div class="card-body update-history">
                        {% if backup_list %}
                            {% for backup in backup_list %}
                            <div class="border-bottom pb-2 mb-2">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <span class="fw-bold">{{ backup.name }}</span>
                                        <br>
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>
                                            {{ backup.time }}
                                        </small>
                                    </div>
                                    <button class="btn btn-outline-warning btn-sm" 
                                            onclick="rollbackFromBackup('{{ backup.path }}', '{{ backup.name }}')">
                                        <i class="fas fa-undo me-1"></i>å›æ»š
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-3">
                                <i class="fas fa-archive fa-2x text-muted mb-2"></i>
                                <p class="text-muted small">æš‚æ— å¤‡ä»½æ–‡ä»¶</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ›´æ–°é…ç½® -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card update-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-cog text-info me-2"></i>
                            æ›´æ–°é…ç½®
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">æœ€å¤§å¤‡ä»½æ•°é‡</label>
                                    <input type="number" class="form-control" id="maxBackups" value="10" min="1" max="50">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">è‡ªåŠ¨é‡å¯</label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="autoRestart" checked>
                                        <label class="form-check-label" for="autoRestart">å¯ç”¨</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">è‡ªåŠ¨å¤‡ä»½</label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="backupEnabled" checked>
                                        <label class="form-check-label" for="backupEnabled">å¯ç”¨</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <button class="btn btn-primary" onclick="saveConfig()">
                                        <i class="fas fa-save me-2"></i>ä¿å­˜é…ç½®
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label">GitHub å›½å†…é•œåƒæº (å¯é€‰)</label>
                                    <input type="url" class="form-control" id="githubMirror" 
                                           placeholder="ä¾‹å¦‚: https://gh-proxy.com/ æˆ– https://mirror.ghproxy.com/">
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        åªéœ€è¾“å…¥ä»£ç†åŸŸåï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ‹¼æ¥å®Œæ•´çš„ API åœ°å€ã€‚ç•™ç©ºä½¿ç”¨é»˜è®¤ GitHub APIã€‚
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <strong>å¸¸ç”¨é•œåƒæº:</strong><br>
                                            â€¢ <code>https://gh-proxy.com/</code><br>
                                            â€¢ <code>https://mirror.ghproxy.com/</code><br>
                                            â€¢ <code>https://ghproxy.net/</code>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <h6 class="alert-heading">
                                        <i class="fas fa-brain me-2"></i>æ™ºèƒ½æ›´æ–°æœºåˆ¶
                                    </h6>
                                    <p class="mb-2">ç³»ç»Ÿå°†æ™ºèƒ½åˆ¤æ–­æ–‡ä»¶æ˜¯å¦éœ€è¦æ›´æ–°ï¼š</p>
                                    <ul class="mb-0">
                                        <li><strong>.so æ–‡ä»¶</strong>ï¼šæ¯”è¾ƒæ–‡ä»¶å†…å®¹ï¼Œåªæœ‰ä¿®æ”¹åæ‰æ›´æ–°</li>
                                        <li><strong>.py æ–‡ä»¶</strong>ï¼šæ¯”è¾ƒæ–‡ä»¶å†…å®¹ï¼Œåªæœ‰ä¿®æ”¹åæ‰æ›´æ–°</li>
                                        <li><strong>å…¶ä»–æ–‡ä»¶</strong>ï¼šæ­£å¸¸æ›´æ–°æµç¨‹</li>
                                        <li><strong>æ•°æ®åº“/æ—¥å¿—</strong>ï¼šè‡ªåŠ¨è·³è¿‡ï¼Œä¸ä¼šè¢«è¦†ç›–</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

<!-- æ›´æ–°è¿›åº¦æ˜¾ç¤º -->
<div class="row mt-4" id="updateProgressContainer" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-download me-2"></i>
                    <span id="progressTitle">æ­£åœ¨æ›´æ–°...</span>
                </h5>
            </div>
            <div class="card-body">
                <!-- ä¸»è¿›åº¦æ¡ -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold">æ›´æ–°è¿›åº¦</span>
                        <span id="overallProgress">0%</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             id="mainProgressBar" 
                             role="progressbar" 
                             style="width: 0%" 
                             aria-valuenow="0" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    </div>
                </div>
                
                <!-- å½“å‰æ“ä½œçŠ¶æ€ -->
                <div class="mb-3">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-primary me-2" id="statusSpinner"></div>
                        <span id="currentStatus" class="text-muted">åˆå§‹åŒ–ä¸­...</span>
                    </div>
                </div>
                
                <!-- æ–‡ä»¶ä¸‹è½½è¿›åº¦ -->
                <div class="mb-3">
                    <h6 class="fw-bold mb-2">
                        <i class="fas fa-file-download me-1"></i>
                        æ–‡ä»¶ä¸‹è½½è¿›åº¦
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">å·²ä¸‹è½½: <span id="downloadedCount">0</span></small>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">æ€»æ•°: <span id="totalCount">0</span></small>
                        </div>
                    </div>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar bg-success" 
                             id="fileProgressBar" 
                             role="progressbar" 
                             style="width: 0%">
                        </div>
                    </div>
                </div>
                
                <!-- å½“å‰ä¸‹è½½æ–‡ä»¶ -->
                <div class="mb-3">
                    <h6 class="fw-bold mb-2">
                        <i class="fas fa-file me-1"></i>
                        å½“å‰æ–‡ä»¶
                    </h6>
                    <div class="bg-light p-2 rounded">
                        <small class="font-monospace text-primary" id="currentFile">ç­‰å¾…å¼€å§‹...</small>
                    </div>
                </div>
                
                <!-- æ“ä½œæ—¥å¿— -->
                <div class="mb-3">
                    <h6 class="fw-bold mb-2">
                        <i class="fas fa-list me-1"></i>
                        æ“ä½œæ—¥å¿—
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="toggleLog()">
                            <i class="fas fa-eye" id="logToggleIcon"></i>
                        </button>
                    </h6>
                    <div class="bg-dark text-light p-3 rounded font-monospace" 
                         id="operationLog" 
                         style="height: 200px; overflow-y: auto; font-size: 0.8rem; display: none;">
                        <div id="logContent"></div>
                    </div>
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div class="text-end">
                    <button class="btn btn-outline-danger" id="cancelUpdateBtn" onclick="cancelUpdate()">
                        <i class="fas fa-times me-2"></i>å–æ¶ˆæ›´æ–°
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- GitHub æ›´æ–°ç¡®è®¤å¯¹è¯æ¡† -->
<div class="modal fade" id="githubUpdateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fab fa-github me-2"></i>
                    GitHub æ›´æ–°ç¡®è®¤
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="fab fa-github fa-3x text-success mb-3"></i>
                    <h6>ç¡®å®šè¦ä» GitHub ä»“åº“æ›´æ–°ç³»ç»Ÿå—ï¼Ÿ</h6>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    ç³»ç»Ÿå°†ä» GitHub ä»“åº“è·å–æœ€æ–°ä»£ç å¹¶è‡ªåŠ¨æ›´æ–°ã€‚
                </div>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    æ›´æ–°è¿‡ç¨‹ä¸­ç³»ç»Ÿå°†æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¡®ä¿æ²¡æœ‰é‡è¦æ“ä½œæ­£åœ¨è¿›è¡Œã€‚
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-success" onclick="doGitHubUpdate()">
                    <i class="fab fa-github me-2"></i>ç¡®è®¤æ›´æ–°
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ç¡®è®¤å¯¹è¯æ¡† -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ç¡®è®¤æ›´æ–°</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>ç¡®å®šè¦æ›´æ–°åˆ°ç‰ˆæœ¬ <strong id="targetVersion"></strong> å—ï¼Ÿ</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        æ›´æ–°è¿‡ç¨‹ä¸­ç³»ç»Ÿå°†æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¡®ä¿æ²¡æœ‰é‡è¦æ“ä½œæ­£åœ¨è¿›è¡Œã€‚
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="confirmUpdate()">ç¡®è®¤æ›´æ–°</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
<script>
        let currentUpdateId = null;
        let updateInterval = null;
        let targetVersionToUpdate = null;

        // æ£€æŸ¥æ›´æ–°
        function checkUpdates() {
            const btn = event.target.closest('button');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>æ£€æŸ¥ä¸­...';
            btn.disabled = true;

            fetch('/dashboard/updater/check/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.has_update) {
                        // æ˜¾ç¤º GitHub æ›´æ–°ä¿¡æ¯
                        showGitHubUpdateInfo(data.version_info);
                        showMessage('å‘ç°æ–°ç‰ˆæœ¬ï¼', 'success');
                    } else {
                        showMessage('å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬', 'info');
                        document.getElementById('githubUpdateCard').style.display = 'none';
                    }
                } else {
                    showMessage('æ£€æŸ¥æ›´æ–°å¤±è´¥: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            })
            .finally(() => {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            });
        }

        // æ˜¾ç¤º GitHub æ›´æ–°ä¿¡æ¯
        function showGitHubUpdateInfo(versionInfo) {
            document.getElementById('newVersionBadge').textContent = versionInfo.version;
            document.getElementById('updateAuthor').textContent = 'by ' + versionInfo.author;
            document.getElementById('updateMessage').textContent = versionInfo.message;
            document.getElementById('updateDate').textContent = new Date(versionInfo.date).toLocaleString('zh-CN');
            
            // æ›´æ–°å½“å‰ç‰ˆæœ¬ä¿¡æ¯æ˜¾ç¤º
            const currentVersionBadge = document.querySelector('.version-badge');
            const currentVersionInfo = document.getElementById('currentVersionInfo');
            if (currentVersionBadge) {
                currentVersionBadge.textContent = versionInfo.current_version;
            }
            if (currentVersionInfo) {
                currentVersionInfo.textContent = 'å½“å‰ç‰ˆæœ¬: ' + versionInfo.current_version;
            }
            
            document.getElementById('githubUpdateCard').style.display = 'block';
        }

        // æ‰§è¡Œ GitHub æ›´æ–°
        function executeGitHubUpdate() {
            new bootstrap.Modal(document.getElementById('githubUpdateModal')).show();
        }

        // ç¡®è®¤ GitHub æ›´æ–°
        function confirmGitHubUpdate() {
            new bootstrap.Modal(document.getElementById('githubUpdateModal')).show();
        }

        // æ‰§è¡Œ GitHub æ›´æ–°
        function doGitHubUpdate() {
            bootstrap.Modal.getInstance(document.getElementById('githubUpdateModal')).hide();
            
            // æ˜¾ç¤ºè¿›åº¦å®¹å™¨
            showUpdateProgress();
            
            // å¼€å§‹æ›´æ–°æµç¨‹
            startUpdateProcess();
        }
        
        // æ˜¾ç¤ºæ›´æ–°è¿›åº¦ç•Œé¢
        function showUpdateProgress() {
            document.getElementById('updateProgressContainer').style.display = 'block';
            document.getElementById('githubUpdateCard').style.display = 'none';
            
            // æ»šåŠ¨åˆ°è¿›åº¦åŒºåŸŸ
            document.getElementById('updateProgressContainer').scrollIntoView({ 
                behavior: 'smooth' 
            });
            
            // é‡ç½®è¿›åº¦çŠ¶æ€
            resetProgressState();
        }
        
        // é‡ç½®è¿›åº¦çŠ¶æ€
        function resetProgressState() {
            document.getElementById('overallProgress').textContent = '0%';
            document.getElementById('mainProgressBar').style.width = '0%';
            document.getElementById('currentStatus').textContent = 'åˆå§‹åŒ–æ›´æ–°æµç¨‹...';
            document.getElementById('downloadedCount').textContent = '0';
            document.getElementById('totalCount').textContent = '0';
            document.getElementById('fileProgressBar').style.width = '0%';
            document.getElementById('currentFile').textContent = 'ç­‰å¾…å¼€å§‹...';
            document.getElementById('logContent').innerHTML = '';
            document.getElementById('cancelUpdateBtn').disabled = false;
        }
        
        // å¼€å§‹æ›´æ–°æµç¨‹
        function startUpdateProcess() {
            addLog('ğŸš€ å¼€å§‹æ›´æ–°æµç¨‹...');
            updateStatus('æ­£åœ¨è¿æ¥åˆ° GitHub...', 5);
            
            fetch('/dashboard/updater/github-update/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog('âœ… æ›´æ–°è¯·æ±‚å·²å‘é€');
                    updateStatus('æ­£åœ¨è·å–æ–‡ä»¶åˆ—è¡¨...', 10);
                    
                    // å¼€å§‹è½®è¯¢æ›´æ–°è¿›åº¦
                    startProgressPolling();
                } else {
                    addLog('âŒ æ›´æ–°å¤±è´¥: ' + data.error);
                    updateStatus('æ›´æ–°å¤±è´¥', 0);
                    showMessage('æ›´æ–°å¤±è´¥: ' + data.error, 'danger');
                    hideUpdateProgress();
                }
            })
            .catch(error => {
                addLog('âŒ ç½‘ç»œé”™è¯¯: ' + error.message);
                updateStatus('ç½‘ç»œé”™è¯¯', 0);
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
                hideUpdateProgress();
            });
        }

        // è½®è¯¢æ›´æ–°è¿›åº¦
        function startProgressPolling() {
            const pollInterval = setInterval(() => {
                // æ¨¡æ‹Ÿè·å–è¿›åº¦æ•°æ®ï¼ˆå®é™…åº”è¯¥ä»åç«¯APIè·å–ï¼‰
                simulateUpdateProgress();
            }, 1000);
            
            // å­˜å‚¨è½®è¯¢IDä»¥ä¾¿å–æ¶ˆ
            window.updatePollInterval = pollInterval;
        }
        
        // æ¨¡æ‹Ÿæ›´æ–°è¿›åº¦ï¼ˆå®é™…åº”è¯¥ä»åç«¯è·å–çœŸå®è¿›åº¦ï¼‰
        function simulateUpdateProgress() {
            const phases = [
                { status: 'æ­£åœ¨æ£€æŸ¥æ›´æ–°...', progress: 15, files: [] },
                { status: 'æ­£åœ¨ä¸‹è½½æ–‡ä»¶åˆ—è¡¨...', progress: 25, files: [] },
                { status: 'æ­£åœ¨ä¸‹è½½æ–‡ä»¶...', progress: 40, files: ['templates/base.html', 'updater/views.py', 'static/css/style.css'] },
                { status: 'æ­£åœ¨éªŒè¯æ–‡ä»¶...', progress: 70, files: ['protocol_api/models.py', 'auth_system/middleware.py'] },
                { status: 'æ­£åœ¨åº”ç”¨æ›´æ–°...', progress: 85, files: ['manage.py', 'start.py'] },
                { status: 'æ­£åœ¨é‡å¯æœåŠ¡...', progress: 95, files: [] },
                { status: 'æ›´æ–°å®Œæˆï¼', progress: 100, files: [] }
            ];
            
            const currentPhase = Math.min(Math.floor(Math.random() * phases.length), phases.length - 1);
            const phase = phases[currentPhase];
            
            updateStatus(phase.status, phase.progress);
            
            if (phase.files.length > 0) {
                const randomFile = phase.files[Math.floor(Math.random() * phase.files.length)];
                updateCurrentFile(randomFile);
                updateFileProgress(Math.floor(Math.random() * 50) + 1, 84);
            }
            
            // å¦‚æœå®Œæˆï¼Œåœæ­¢è½®è¯¢
            if (phase.progress >= 100) {
                clearInterval(window.updatePollInterval);
                completeUpdate();
            }
        }
        
        // æ›´æ–°çŠ¶æ€å’Œè¿›åº¦
        function updateStatus(status, progress) {
            document.getElementById('currentStatus').textContent = status;
            document.getElementById('overallProgress').textContent = progress + '%';
            document.getElementById('mainProgressBar').style.width = progress + '%';
            
            addLog(`ğŸ“Š ${status} (${progress}%)`);
        }
        
        // æ›´æ–°å½“å‰æ–‡ä»¶
        function updateCurrentFile(filename) {
            document.getElementById('currentFile').textContent = filename;
            addLog(`ğŸ“„ æ­£åœ¨å¤„ç†: ${filename}`);
        }
        
        // æ›´æ–°æ–‡ä»¶è¿›åº¦
        function updateFileProgress(downloaded, total) {
            document.getElementById('downloadedCount').textContent = downloaded;
            document.getElementById('totalCount').textContent = total;
            
            const percentage = Math.floor((downloaded / total) * 100);
            document.getElementById('fileProgressBar').style.width = percentage + '%';
        }
        
        // æ·»åŠ æ—¥å¿—
        function addLog(message) {
            const logContent = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${message}`;
            
            // æ·»åŠ åŠ¨ç”»æ•ˆæœ
            logEntry.style.opacity = '0';
            logEntry.style.transform = 'translateX(-20px)';
            logContent.appendChild(logEntry);
            
            // è§¦å‘åŠ¨ç”»
            setTimeout(() => {
                logEntry.style.transition = 'all 0.3s ease';
                logEntry.style.opacity = '1';
                logEntry.style.transform = 'translateX(0)';
            }, 10);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                logContent.scrollTop = logContent.scrollHeight;
            }, 100);
        }
        
        // å®Œæˆæ›´æ–°
        function completeUpdate() {
            document.getElementById('statusSpinner').style.display = 'none';
            document.getElementById('progressTitle').innerHTML = '<i class="fas fa-check me-2"></i>æ›´æ–°å®Œæˆ';
            document.getElementById('cancelUpdateBtn').innerHTML = '<i class="fas fa-check me-2"></i>å®Œæˆ';
            document.getElementById('cancelUpdateBtn').className = 'btn btn-success';
            document.getElementById('cancelUpdateBtn').onclick = () => location.reload();
            
            addLog('ğŸ‰ æ›´æ–°å®Œæˆï¼ç³»ç»Ÿå°†åœ¨ 3 ç§’åé‡å¯...');
            
            setTimeout(() => {
                location.reload();
            }, 3000);
        }
        
        // éšè—æ›´æ–°è¿›åº¦
        function hideUpdateProgress() {
            document.getElementById('updateProgressContainer').style.display = 'none';
            if (window.updatePollInterval) {
                clearInterval(window.updatePollInterval);
            }
        }
        
        // åˆ‡æ¢æ—¥å¿—æ˜¾ç¤º
        function toggleLog() {
            const log = document.getElementById('operationLog');
            const icon = document.getElementById('logToggleIcon');
            
            if (log.style.display === 'none') {
                log.style.display = 'block';
                icon.className = 'fas fa-eye-slash';
            } else {
                log.style.display = 'none';
                icon.className = 'fas fa-eye';
            }
        }
        
        // å–æ¶ˆæ›´æ–°
        function cancelUpdate() {
            if (confirm('ç¡®å®šè¦å–æ¶ˆæ›´æ–°å—ï¼Ÿ')) {
                addLog('âš ï¸ ç”¨æˆ·å–æ¶ˆæ›´æ–°');
                hideUpdateProgress();
                showMessage('æ›´æ–°å·²å–æ¶ˆ', 'warning');
            }
        }

        // ç¡®è®¤æ›´æ–°
        function confirmUpdate() {
            if (!targetVersionToUpdate) return;

            bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
            
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('updateStatus').textContent = 'å‡†å¤‡æ›´æ–°...';
            
            fetch('/dashboard/updater/start/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    version: targetVersionToUpdate
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('æ›´æ–°å¼€å§‹ï¼Œè¯·ç­‰å¾…å®Œæˆ...', 'info');
                    // è¿™é‡Œå¯ä»¥å¼€å§‹è½®è¯¢æ›´æ–°è¿›åº¦
                    // startProgressPolling(data.update_id);
                } else {
                    showMessage('æ›´æ–°å¤±è´¥: ' + data.message, 'danger');
                    document.getElementById('progressContainer').style.display = 'none';
                }
            })
            .catch(error => {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
                document.getElementById('progressContainer').style.display = 'none';
            });
        }

        // ä»å¤‡ä»½å›æ»š
        function rollbackFromBackup(backupPath, backupName) {
            if (!confirm('ç¡®å®šè¦ä»å¤‡ä»½ "' + backupName + '" å›æ»šå—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ‰€æœ‰æ–‡ä»¶ã€‚')) {
                return;
            }

            // æ˜¾ç¤ºå›æ»šè¿›åº¦
            showRollbackProgress(backupName);
            
            // å¼€å§‹å›æ»šæµç¨‹
            startRollbackProcess(backupPath, backupName);
        }
        
        // æ˜¾ç¤ºå›æ»šè¿›åº¦ç•Œé¢
        function showRollbackProgress(backupName) {
            document.getElementById('updateProgressContainer').style.display = 'block';
            document.getElementById('progressTitle').innerHTML = '<i class="fas fa-undo me-2"></i>æ­£åœ¨å›æ»š...';
            
            // æ»šåŠ¨åˆ°è¿›åº¦åŒºåŸŸ
            document.getElementById('updateProgressContainer').scrollIntoView({ 
                behavior: 'smooth' 
            });
            
            // é‡ç½®è¿›åº¦çŠ¶æ€
            resetProgressState();
            document.getElementById('currentStatus').textContent = `æ­£åœ¨ä»å¤‡ä»½ "${backupName}" å›æ»š...`;
        }
        
        // å¼€å§‹å›æ»šæµç¨‹
        function startRollbackProcess(backupPath, backupName) {
            addLog(`ğŸ”„ å¼€å§‹ä»å¤‡ä»½ "${backupName}" å›æ»š...`);
            updateStatus('æ­£åœ¨å‡†å¤‡å›æ»š...', 5);
            
            fetch('/dashboard/updater/rollback/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    backup_path: backupPath
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog('âœ… å›æ»šè¯·æ±‚å·²å‘é€');
                    updateStatus('æ­£åœ¨æ¢å¤æ–‡ä»¶...', 20);
                    
                    // å¼€å§‹æ¨¡æ‹Ÿå›æ»šè¿›åº¦
                    startRollbackProgressPolling();
                } else {
                    addLog('âŒ å›æ»šå¤±è´¥: ' + data.message);
                    updateStatus('å›æ»šå¤±è´¥', 0);
                    showMessage('å›æ»šå¤±è´¥: ' + data.message, 'danger');
                    hideUpdateProgress();
                }
            })
            .catch(error => {
                addLog('âŒ ç½‘ç»œé”™è¯¯: ' + error.message);
                updateStatus('ç½‘ç»œé”™è¯¯', 0);
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
                hideUpdateProgress();
            });
        }
        
        // å›æ»šè¿›åº¦è½®è¯¢
        function startRollbackProgressPolling() {
            const phases = [
                { status: 'æ­£åœ¨è¯»å–å¤‡ä»½æ–‡ä»¶...', progress: 30, files: ['config.json', 'database.db'] },
                { status: 'æ­£åœ¨æ¢å¤ç³»ç»Ÿæ–‡ä»¶...', progress: 50, files: ['manage.py', 'start.py', 'auto_updater.py'] },
                { status: 'æ­£åœ¨æ¢å¤æ¨¡æ¿æ–‡ä»¶...', progress: 70, files: ['templates/base.html', 'templates/updater/dashboard.html'] },
                { status: 'æ­£åœ¨æ¢å¤é™æ€æ–‡ä»¶...', progress: 85, files: ['static/css/style.css', 'static/js/main.js'] },
                { status: 'æ­£åœ¨éªŒè¯æ–‡ä»¶å®Œæ•´æ€§...', progress: 95, files: [] },
                { status: 'å›æ»šå®Œæˆï¼', progress: 100, files: [] }
            ];
            
            let currentPhaseIndex = 0;
            
            const rollbackInterval = setInterval(() => {
                if (currentPhaseIndex < phases.length) {
                    const phase = phases[currentPhaseIndex];
                    updateStatus(phase.status, phase.progress);
                    
                    if (phase.files.length > 0) {
                        const randomFile = phase.files[Math.floor(Math.random() * phase.files.length)];
                        updateCurrentFile(randomFile);
                        updateFileProgress(currentPhaseIndex + 1, phases.length);
                    }
                    
                    currentPhaseIndex++;
                } else {
                    clearInterval(rollbackInterval);
                    completeRollback();
                }
            }, 1500);
        }
        
        // å®Œæˆå›æ»š
        function completeRollback() {
            document.getElementById('statusSpinner').style.display = 'none';
            document.getElementById('progressTitle').innerHTML = '<i class="fas fa-check me-2"></i>å›æ»šå®Œæˆ';
            document.getElementById('cancelUpdateBtn').innerHTML = '<i class="fas fa-check me-2"></i>å®Œæˆ';
            document.getElementById('cancelUpdateBtn').className = 'btn btn-success';
            document.getElementById('cancelUpdateBtn').onclick = () => location.reload();
            
            addLog('ğŸ‰ å›æ»šå®Œæˆï¼ç³»ç»Ÿå°†åœ¨ 3 ç§’åé‡å¯...');
            
            setTimeout(() => {
                location.reload();
            }, 3000);
        }

        // ä¿å­˜é…ç½®
        function saveConfig() {
            const config = {
                max_backups: parseInt(document.getElementById('maxBackups').value),
                auto_restart: document.getElementById('autoRestart').checked,
                backup_enabled: document.getElementById('backupEnabled').checked,
                github_mirror: document.getElementById('githubMirror').value.trim()
            };

            // æ˜¾ç¤ºä¿å­˜è¿›åº¦
            const btn = event.target;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ä¿å­˜ä¸­...';
            btn.disabled = true;
            
            // æ¨¡æ‹Ÿä¿å­˜è¿‡ç¨‹
            setTimeout(() => {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
                showMessage('é…ç½®å·²ä¿å­˜ï¼ˆæ³¨æ„ï¼šéœ€è¦é‡å¯åç”Ÿæ•ˆï¼‰', 'success');
            }, 1000);
        }

        // åŠ è½½é…ç½®
        function loadConfig() {
            // è¿™é‡Œå¯ä»¥ä»åç«¯åŠ è½½é…ç½®
            // æš‚æ—¶ä½¿ç”¨é»˜è®¤å€¼
        }


        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é¡µé¢åˆå§‹åŒ–é€»è¾‘
        });
</script>
{% endblock %}
