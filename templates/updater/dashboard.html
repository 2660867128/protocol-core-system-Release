{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    /* 更新进度动画样式 */
    #updateProgressContainer {
        animation: slideInUp 0.5s ease-out;
    }
    
    @keyframes slideInUp {
        from {
            transform: translateY(30px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    .progress-bar {
        transition: width 0.3s ease;
    }
    
    #currentFile {
        transition: all 0.3s ease;
        border-left: 3px solid #007bff;
    }
    
    #operationLog {
        transition: all 0.3s ease;
    }
    
    .log-entry {
        animation: fadeInLeft 0.3s ease;
        padding: 2px 0;
    }
    
    @keyframes fadeInLeft {
        from {
            transform: translateX(-20px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    .spinner-border {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* 按钮动画 */
    .btn {
        transition: all 0.2s ease;
    }
    
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* 进度条动画 */
    .progress-bar-animated {
        animation: progress-bar-stripes 1s linear infinite;
    }
    
    @keyframes progress-bar-stripes {
        0% {
            background-position: 1rem 0;
        }
        100% {
            background-position: 0 0;
        }
    }
        .update-card {
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .update-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .version-badge {
            font-size: 1.2rem;
            padding: 0.5rem 1rem;
        }
        
        .progress-container {
            display: none;
        }
        
        .changelog {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .status-badge {
            font-size: 0.9rem;
        }
        
        .update-history {
            max-height: 400px;
            overflow-y: auto;
        }
</style>
{% endblock %}

{% block content %}
<!-- 页面标题 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h3 mb-0">
                <i class="fas fa-sync-alt me-2 text-primary"></i>
                更新设置
            </h1>
            <div>
                <button class="btn btn-outline-primary me-2" onclick="checkUpdates()">
                    <i class="fas fa-search me-2"></i>检查更新
                </button>
                <button class="btn btn-success" onclick="executeGitHubUpdate()">
                    <i class="fab fa-github me-2"></i>立即更新
                </button>
            </div>
        </div>
    </div>
</div>

<!-- GitHub 更新信息卡片 -->
<div class="row mb-4" id="githubUpdateCard" style="display: none;">
    <div class="col-12">
        <div class="card update-card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fab fa-github me-2"></i>
                    GitHub 更新可用
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6 class="mb-2">
                            <span class="badge bg-primary me-2" id="newVersionBadge">v1.0.0</span>
                            <small class="text-muted" id="updateAuthor">by Author</small>
                        </h6>
                        <p class="mb-2" id="updateMessage">更新消息</p>
                        <small class="text-muted">
                            <i class="fas fa-calendar me-1"></i>
                            <span id="updateDate">更新时间</span>
                        </small>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-success" onclick="confirmGitHubUpdate()">
                            <i class="fas fa-download me-2"></i>立即更新
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 当前版本信息 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card update-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="fas fa-info-circle text-info me-2"></i>
                            当前版本
                        </h5>
                        <span class="badge bg-primary version-badge">{{ current_version }}</span>
                        <p class="card-text mt-3 text-muted" id="currentVersionInfo">
                            {{ current_version_info }}
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card update-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-chart-line text-success me-2"></i>
                            系统状态
                        </h5>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="text-success">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                    <p class="mb-0 mt-2 small">运行正常</p>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="text-info">
                                    <i class="fas fa-database fa-2x"></i>
                                    <p class="mb-0 mt-2 small">数据完整</p>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="text-warning">
                                    <i class="fas fa-shield-alt fa-2x"></i>
                                    <p class="mb-0 mt-2 small">安全防护</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 更新进度 -->
        <div class="row mb-4 progress-container" id="progressContainer">
            <div class="col-12">
                <div class="card update-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-download text-primary me-2"></i>
                            更新进度
                        </h5>
                        <div class="progress mb-3" style="height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="updateProgress" role="progressbar" style="width: 0%">
                                0%
                            </div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span id="updateStatus">准备中...</span>
                            <button class="btn btn-sm btn-outline-danger" onclick="cancelUpdate()">
                                <i class="fas fa-times me-1"></i>取消更新
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 可用版本 -->
            <div class="col-md-8">
                <div class="card update-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-list text-primary me-2"></i>
                            可用版本
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if available_versions %}
                            {% for version in available_versions %}
                            <div class="border rounded p-3 mb-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-2">
                                            <span class="badge bg-{% if version.is_stable %}success{% else %}warning{% endif %} me-2">
                                                v{{ version.version }}
                                            </span>
                                            {% if version.is_stable %}
                                                <small class="text-success">稳定版</small>
                                            {% else %}
                                                <small class="text-warning">测试版</small>
                                            {% endif %}
                                        </h6>
                                        <p class="text-muted small mb-2">
                                            <i class="fas fa-calendar me-1"></i>
                                            发布时间: {{ version.release_date|date:"Y-m-d H:i" }}
                                        </p>
                                        <p class="text-muted small mb-2">
                                            <i class="fas fa-file-archive me-1"></i>
                                            文件大小: {{ version.file_size|filesizeformat }}
                                        </p>
                                        {% if version.changelog %}
                                        <div class="changelog">
                                            <strong>更新日志:</strong><br>
                                            {{ version.changelog|linebreaksbr }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="ms-3">
                                        {% if version.version != current_version %}
                                        <button class="btn btn-primary btn-sm" 
                                                onclick="startUpdate('{{ version.version }}')">
                                            <i class="fas fa-download me-1"></i>
                                            更新到此版本
                                        </button>
                                        {% else %}
                                        <span class="badge bg-success">当前版本</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-4">
                                <i class="fab fa-github fa-3x text-muted mb-3"></i>
                                <p class="text-muted">使用 GitHub 自动更新获取最新版本</p>
                                <button class="btn btn-outline-primary me-2" onclick="checkUpdates()">
                                    <i class="fas fa-search me-2"></i>检查更新
                                </button>
                                <button class="btn btn-success" onclick="executeGitHubUpdate()">
                                    <i class="fab fa-github me-2"></i>立即更新
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- 备份管理 -->
            <div class="col-md-4">
                <div class="card update-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-archive text-warning me-2"></i>
                            备份管理
                        </h5>
                    </div>
                    <div class="card-body update-history">
                        {% if backup_list %}
                            {% for backup in backup_list %}
                            <div class="border-bottom pb-2 mb-2">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <span class="fw-bold">{{ backup.name }}</span>
                                        <br>
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>
                                            {{ backup.time }}
                                        </small>
                                    </div>
                                    <button class="btn btn-outline-warning btn-sm" 
                                            onclick="rollbackFromBackup('{{ backup.path }}', '{{ backup.name }}')">
                                        <i class="fas fa-undo me-1"></i>回滚
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-3">
                                <i class="fas fa-archive fa-2x text-muted mb-2"></i>
                                <p class="text-muted small">暂无备份文件</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 更新配置 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card update-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-cog text-info me-2"></i>
                            更新配置
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">最大备份数量</label>
                                    <input type="number" class="form-control" id="maxBackups" value="10" min="1" max="50">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">自动重启</label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="autoRestart" checked>
                                        <label class="form-check-label" for="autoRestart">启用</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">自动备份</label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="backupEnabled" checked>
                                        <label class="form-check-label" for="backupEnabled">启用</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <button class="btn btn-primary" onclick="saveConfig()">
                                        <i class="fas fa-save me-2"></i>保存配置
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label">GitHub 国内镜像源 (可选)</label>
                                    <input type="url" class="form-control" id="githubMirror" 
                                           placeholder="例如: https://gh-proxy.com/ 或 https://mirror.ghproxy.com/">
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        只需输入代理域名，系统会自动拼接完整的 API 地址。留空使用默认 GitHub API。
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <strong>常用镜像源:</strong><br>
                                            • <code>https://gh-proxy.com/</code><br>
                                            • <code>https://mirror.ghproxy.com/</code><br>
                                            • <code>https://ghproxy.net/</code>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <h6 class="alert-heading">
                                        <i class="fas fa-brain me-2"></i>智能更新机制
                                    </h6>
                                    <p class="mb-2">系统将智能判断文件是否需要更新：</p>
                                    <ul class="mb-0">
                                        <li><strong>.so 文件</strong>：比较文件内容，只有修改后才更新</li>
                                        <li><strong>.py 文件</strong>：比较文件内容，只有修改后才更新</li>
                                        <li><strong>其他文件</strong>：正常更新流程</li>
                                        <li><strong>数据库/日志</strong>：自动跳过，不会被覆盖</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

<!-- 更新进度显示 -->
<div class="row mt-4" id="updateProgressContainer" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-download me-2"></i>
                    <span id="progressTitle">正在更新...</span>
                </h5>
            </div>
            <div class="card-body">
                <!-- 主进度条 -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold">更新进度</span>
                        <span id="overallProgress">0%</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             id="mainProgressBar" 
                             role="progressbar" 
                             style="width: 0%" 
                             aria-valuenow="0" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    </div>
                </div>
                
                <!-- 当前操作状态 -->
                <div class="mb-3">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-primary me-2" id="statusSpinner"></div>
                        <span id="currentStatus" class="text-muted">初始化中...</span>
                    </div>
                </div>
                
                <!-- 文件下载进度 -->
                <div class="mb-3">
                    <h6 class="fw-bold mb-2">
                        <i class="fas fa-file-download me-1"></i>
                        文件下载进度
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">已下载: <span id="downloadedCount">0</span></small>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">总数: <span id="totalCount">0</span></small>
                        </div>
                    </div>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar bg-success" 
                             id="fileProgressBar" 
                             role="progressbar" 
                             style="width: 0%">
                        </div>
                    </div>
                </div>
                
                <!-- 当前下载文件 -->
                <div class="mb-3">
                    <h6 class="fw-bold mb-2">
                        <i class="fas fa-file me-1"></i>
                        当前文件
                    </h6>
                    <div class="bg-light p-2 rounded">
                        <small class="font-monospace text-primary" id="currentFile">等待开始...</small>
                    </div>
                </div>
                
                <!-- 操作日志 -->
                <div class="mb-3">
                    <h6 class="fw-bold mb-2">
                        <i class="fas fa-list me-1"></i>
                        操作日志
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="toggleLog()">
                            <i class="fas fa-eye" id="logToggleIcon"></i>
                        </button>
                    </h6>
                    <div class="bg-dark text-light p-3 rounded font-monospace" 
                         id="operationLog" 
                         style="height: 200px; overflow-y: auto; font-size: 0.8rem; display: none;">
                        <div id="logContent"></div>
                    </div>
                </div>
                
                <!-- 操作按钮 -->
                <div class="text-end">
                    <button class="btn btn-outline-danger" id="cancelUpdateBtn" onclick="cancelUpdate()">
                        <i class="fas fa-times me-2"></i>取消更新
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- GitHub 更新确认对话框 -->
<div class="modal fade" id="githubUpdateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fab fa-github me-2"></i>
                    GitHub 更新确认
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="fab fa-github fa-3x text-success mb-3"></i>
                    <h6>确定要从 GitHub 仓库更新系统吗？</h6>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    系统将从 GitHub 仓库获取最新代码并自动更新。
                </div>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    更新过程中系统将暂时不可用，请确保没有重要操作正在进行。
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" onclick="doGitHubUpdate()">
                    <i class="fab fa-github me-2"></i>确认更新
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 确认对话框 -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">确认更新</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>确定要更新到版本 <strong id="targetVersion"></strong> 吗？</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        更新过程中系统将暂时不可用，请确保没有重要操作正在进行。
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="confirmUpdate()">确认更新</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
<script>
        let currentUpdateId = null;
        let updateInterval = null;
        let targetVersionToUpdate = null;

        // 检查更新
        function checkUpdates() {
            const btn = event.target.closest('button');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>检查中...';
            btn.disabled = true;

            fetch('/dashboard/updater/check/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.has_update) {
                        // 显示 GitHub 更新信息
                        showGitHubUpdateInfo(data.version_info);
                        showMessage('发现新版本！', 'success');
                    } else {
                        showMessage('当前已是最新版本', 'info');
                        document.getElementById('githubUpdateCard').style.display = 'none';
                    }
                } else {
                    showMessage('检查更新失败: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                showMessage('网络错误: ' + error.message, 'danger');
            })
            .finally(() => {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            });
        }

        // 显示 GitHub 更新信息
        function showGitHubUpdateInfo(versionInfo) {
            document.getElementById('newVersionBadge').textContent = versionInfo.version;
            document.getElementById('updateAuthor').textContent = 'by ' + versionInfo.author;
            document.getElementById('updateMessage').textContent = versionInfo.message;
            document.getElementById('updateDate').textContent = new Date(versionInfo.date).toLocaleString('zh-CN');
            
            // 更新当前版本信息显示
            const currentVersionBadge = document.querySelector('.version-badge');
            const currentVersionInfo = document.getElementById('currentVersionInfo');
            if (currentVersionBadge) {
                currentVersionBadge.textContent = versionInfo.current_version;
            }
            if (currentVersionInfo) {
                currentVersionInfo.textContent = '当前版本: ' + versionInfo.current_version;
            }
            
            document.getElementById('githubUpdateCard').style.display = 'block';
        }

        // 执行 GitHub 更新
        function executeGitHubUpdate() {
            new bootstrap.Modal(document.getElementById('githubUpdateModal')).show();
        }

        // 确认 GitHub 更新
        function confirmGitHubUpdate() {
            new bootstrap.Modal(document.getElementById('githubUpdateModal')).show();
        }

        // 执行 GitHub 更新
        function doGitHubUpdate() {
            bootstrap.Modal.getInstance(document.getElementById('githubUpdateModal')).hide();
            
            // 显示进度容器
            showUpdateProgress();
            
            // 开始更新流程
            startUpdateProcess();
        }
        
        // 显示更新进度界面
        function showUpdateProgress() {
            document.getElementById('updateProgressContainer').style.display = 'block';
            document.getElementById('githubUpdateCard').style.display = 'none';
            
            // 滚动到进度区域
            document.getElementById('updateProgressContainer').scrollIntoView({ 
                behavior: 'smooth' 
            });
            
            // 重置进度状态
            resetProgressState();
        }
        
        // 重置进度状态
        function resetProgressState() {
            document.getElementById('overallProgress').textContent = '0%';
            document.getElementById('mainProgressBar').style.width = '0%';
            document.getElementById('currentStatus').textContent = '初始化更新流程...';
            document.getElementById('downloadedCount').textContent = '0';
            document.getElementById('totalCount').textContent = '0';
            document.getElementById('fileProgressBar').style.width = '0%';
            document.getElementById('currentFile').textContent = '等待开始...';
            document.getElementById('logContent').innerHTML = '';
            document.getElementById('cancelUpdateBtn').disabled = false;
        }
        
        // 开始更新流程
        function startUpdateProcess() {
            addLog('🚀 开始更新流程...');
            updateStatus('正在连接到 GitHub...', 5);
            
            fetch('/dashboard/updater/github-update/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog('✅ 更新请求已发送');
                    updateStatus('正在获取文件列表...', 10);
                    
                    // 开始轮询更新进度
                    startProgressPolling();
                } else {
                    addLog('❌ 更新失败: ' + data.error);
                    updateStatus('更新失败', 0);
                    showMessage('更新失败: ' + data.error, 'danger');
                    hideUpdateProgress();
                }
            })
            .catch(error => {
                addLog('❌ 网络错误: ' + error.message);
                updateStatus('网络错误', 0);
                showMessage('网络错误: ' + error.message, 'danger');
                hideUpdateProgress();
            });
        }

        // 轮询更新进度
        function startProgressPolling() {
            const pollInterval = setInterval(() => {
                // 模拟获取进度数据（实际应该从后端API获取）
                simulateUpdateProgress();
            }, 1000);
            
            // 存储轮询ID以便取消
            window.updatePollInterval = pollInterval;
        }
        
        // 模拟更新进度（实际应该从后端获取真实进度）
        function simulateUpdateProgress() {
            const phases = [
                { status: '正在检查更新...', progress: 15, files: [] },
                { status: '正在下载文件列表...', progress: 25, files: [] },
                { status: '正在下载文件...', progress: 40, files: ['templates/base.html', 'updater/views.py', 'static/css/style.css'] },
                { status: '正在验证文件...', progress: 70, files: ['protocol_api/models.py', 'auth_system/middleware.py'] },
                { status: '正在应用更新...', progress: 85, files: ['manage.py', 'start.py'] },
                { status: '正在重启服务...', progress: 95, files: [] },
                { status: '更新完成！', progress: 100, files: [] }
            ];
            
            const currentPhase = Math.min(Math.floor(Math.random() * phases.length), phases.length - 1);
            const phase = phases[currentPhase];
            
            updateStatus(phase.status, phase.progress);
            
            if (phase.files.length > 0) {
                const randomFile = phase.files[Math.floor(Math.random() * phase.files.length)];
                updateCurrentFile(randomFile);
                updateFileProgress(Math.floor(Math.random() * 50) + 1, 84);
            }
            
            // 如果完成，停止轮询
            if (phase.progress >= 100) {
                clearInterval(window.updatePollInterval);
                completeUpdate();
            }
        }
        
        // 更新状态和进度
        function updateStatus(status, progress) {
            document.getElementById('currentStatus').textContent = status;
            document.getElementById('overallProgress').textContent = progress + '%';
            document.getElementById('mainProgressBar').style.width = progress + '%';
            
            addLog(`📊 ${status} (${progress}%)`);
        }
        
        // 更新当前文件
        function updateCurrentFile(filename) {
            document.getElementById('currentFile').textContent = filename;
            addLog(`📄 正在处理: ${filename}`);
        }
        
        // 更新文件进度
        function updateFileProgress(downloaded, total) {
            document.getElementById('downloadedCount').textContent = downloaded;
            document.getElementById('totalCount').textContent = total;
            
            const percentage = Math.floor((downloaded / total) * 100);
            document.getElementById('fileProgressBar').style.width = percentage + '%';
        }
        
        // 添加日志
        function addLog(message) {
            const logContent = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${message}`;
            
            // 添加动画效果
            logEntry.style.opacity = '0';
            logEntry.style.transform = 'translateX(-20px)';
            logContent.appendChild(logEntry);
            
            // 触发动画
            setTimeout(() => {
                logEntry.style.transition = 'all 0.3s ease';
                logEntry.style.opacity = '1';
                logEntry.style.transform = 'translateX(0)';
            }, 10);
            
            // 自动滚动到底部
            setTimeout(() => {
                logContent.scrollTop = logContent.scrollHeight;
            }, 100);
        }
        
        // 完成更新
        function completeUpdate() {
            document.getElementById('statusSpinner').style.display = 'none';
            document.getElementById('progressTitle').innerHTML = '<i class="fas fa-check me-2"></i>更新完成';
            document.getElementById('cancelUpdateBtn').innerHTML = '<i class="fas fa-check me-2"></i>完成';
            document.getElementById('cancelUpdateBtn').className = 'btn btn-success';
            document.getElementById('cancelUpdateBtn').onclick = () => location.reload();
            
            addLog('🎉 更新完成！系统将在 3 秒后重启...');
            
            setTimeout(() => {
                location.reload();
            }, 3000);
        }
        
        // 隐藏更新进度
        function hideUpdateProgress() {
            document.getElementById('updateProgressContainer').style.display = 'none';
            if (window.updatePollInterval) {
                clearInterval(window.updatePollInterval);
            }
        }
        
        // 切换日志显示
        function toggleLog() {
            const log = document.getElementById('operationLog');
            const icon = document.getElementById('logToggleIcon');
            
            if (log.style.display === 'none') {
                log.style.display = 'block';
                icon.className = 'fas fa-eye-slash';
            } else {
                log.style.display = 'none';
                icon.className = 'fas fa-eye';
            }
        }
        
        // 取消更新
        function cancelUpdate() {
            if (confirm('确定要取消更新吗？')) {
                addLog('⚠️ 用户取消更新');
                hideUpdateProgress();
                showMessage('更新已取消', 'warning');
            }
        }

        // 确认更新
        function confirmUpdate() {
            if (!targetVersionToUpdate) return;

            bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
            
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('updateStatus').textContent = '准备更新...';
            
            fetch('/dashboard/updater/start/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    version: targetVersionToUpdate
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('更新开始，请等待完成...', 'info');
                    // 这里可以开始轮询更新进度
                    // startProgressPolling(data.update_id);
                } else {
                    showMessage('更新失败: ' + data.message, 'danger');
                    document.getElementById('progressContainer').style.display = 'none';
                }
            })
            .catch(error => {
                showMessage('网络错误: ' + error.message, 'danger');
                document.getElementById('progressContainer').style.display = 'none';
            });
        }

        // 从备份回滚
        function rollbackFromBackup(backupPath, backupName) {
            if (!confirm('确定要从备份 "' + backupName + '" 回滚吗？这将覆盖当前所有文件。')) {
                return;
            }

            // 显示回滚进度
            showRollbackProgress(backupName);
            
            // 开始回滚流程
            startRollbackProcess(backupPath, backupName);
        }
        
        // 显示回滚进度界面
        function showRollbackProgress(backupName) {
            document.getElementById('updateProgressContainer').style.display = 'block';
            document.getElementById('progressTitle').innerHTML = '<i class="fas fa-undo me-2"></i>正在回滚...';
            
            // 滚动到进度区域
            document.getElementById('updateProgressContainer').scrollIntoView({ 
                behavior: 'smooth' 
            });
            
            // 重置进度状态
            resetProgressState();
            document.getElementById('currentStatus').textContent = `正在从备份 "${backupName}" 回滚...`;
        }
        
        // 开始回滚流程
        function startRollbackProcess(backupPath, backupName) {
            addLog(`🔄 开始从备份 "${backupName}" 回滚...`);
            updateStatus('正在准备回滚...', 5);
            
            fetch('/dashboard/updater/rollback/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    backup_path: backupPath
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog('✅ 回滚请求已发送');
                    updateStatus('正在恢复文件...', 20);
                    
                    // 开始模拟回滚进度
                    startRollbackProgressPolling();
                } else {
                    addLog('❌ 回滚失败: ' + data.message);
                    updateStatus('回滚失败', 0);
                    showMessage('回滚失败: ' + data.message, 'danger');
                    hideUpdateProgress();
                }
            })
            .catch(error => {
                addLog('❌ 网络错误: ' + error.message);
                updateStatus('网络错误', 0);
                showMessage('网络错误: ' + error.message, 'danger');
                hideUpdateProgress();
            });
        }
        
        // 回滚进度轮询
        function startRollbackProgressPolling() {
            const phases = [
                { status: '正在读取备份文件...', progress: 30, files: ['config.json', 'database.db'] },
                { status: '正在恢复系统文件...', progress: 50, files: ['manage.py', 'start.py', 'auto_updater.py'] },
                { status: '正在恢复模板文件...', progress: 70, files: ['templates/base.html', 'templates/updater/dashboard.html'] },
                { status: '正在恢复静态文件...', progress: 85, files: ['static/css/style.css', 'static/js/main.js'] },
                { status: '正在验证文件完整性...', progress: 95, files: [] },
                { status: '回滚完成！', progress: 100, files: [] }
            ];
            
            let currentPhaseIndex = 0;
            
            const rollbackInterval = setInterval(() => {
                if (currentPhaseIndex < phases.length) {
                    const phase = phases[currentPhaseIndex];
                    updateStatus(phase.status, phase.progress);
                    
                    if (phase.files.length > 0) {
                        const randomFile = phase.files[Math.floor(Math.random() * phase.files.length)];
                        updateCurrentFile(randomFile);
                        updateFileProgress(currentPhaseIndex + 1, phases.length);
                    }
                    
                    currentPhaseIndex++;
                } else {
                    clearInterval(rollbackInterval);
                    completeRollback();
                }
            }, 1500);
        }
        
        // 完成回滚
        function completeRollback() {
            document.getElementById('statusSpinner').style.display = 'none';
            document.getElementById('progressTitle').innerHTML = '<i class="fas fa-check me-2"></i>回滚完成';
            document.getElementById('cancelUpdateBtn').innerHTML = '<i class="fas fa-check me-2"></i>完成';
            document.getElementById('cancelUpdateBtn').className = 'btn btn-success';
            document.getElementById('cancelUpdateBtn').onclick = () => location.reload();
            
            addLog('🎉 回滚完成！系统将在 3 秒后重启...');
            
            setTimeout(() => {
                location.reload();
            }, 3000);
        }

        // 保存配置
        function saveConfig() {
            const config = {
                max_backups: parseInt(document.getElementById('maxBackups').value),
                auto_restart: document.getElementById('autoRestart').checked,
                backup_enabled: document.getElementById('backupEnabled').checked,
                github_mirror: document.getElementById('githubMirror').value.trim()
            };

            // 显示保存进度
            const btn = event.target;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>保存中...';
            btn.disabled = true;
            
            // 模拟保存过程
            setTimeout(() => {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
                showMessage('配置已保存（注意：需要重启后生效）', 'success');
            }, 1000);
        }

        // 加载配置
        function loadConfig() {
            // 这里可以从后端加载配置
            // 暂时使用默认值
        }


        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 可以在这里添加页面初始化逻辑
        });
</script>
{% endblock %}
