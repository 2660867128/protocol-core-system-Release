{% extends 'base.html' %}

{% block title %}å¾®ä¿¡ç™»å½• - åè®®æ ¸å¿ƒç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fab fa-weixin me-2 text-success"></i>å¾®ä¿¡ç™»å½•
        </h2>
        <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>è¿”å›ä»ªè¡¨æ¿
        </a>
    </div>

    <!-- è¿æ¥é€‰æ‹©åŒºåŸŸ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-gradient-primary text-white border-0">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-link me-3 fa-lg"></i>
                        <h5 class="mb-0 fw-bold">é€‰æ‹©è¿æ¥</h5>
                        <span class="badge bg-light text-primary ms-auto">{{ connections|length }} ä¸ªè¿æ¥</span>
                    </div>
                </div>
                <div class="card-body p-4">
                    {% if connections %}
                    <div class="row g-4">
                        {% for connection in connections %}
                        <div class="col-lg-4 col-md-6">
                            <div class="connection-card card h-100 border-0 shadow-sm" data-connection-id="{{ connection.id }}">
                                <div class="card-body p-4">
                                    <!-- è¿æ¥å¤´éƒ¨ä¿¡æ¯ -->
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div class="connection-info">
                                            <h6 class="card-title mb-1 fw-bold text-dark">{{ connection.name }}</h6>
                                            <div class="connection-type mb-2">
                                                <span class="badge bg-{{ connection.connection_type|yesno:'info,warning,success' }} bg-opacity-10 text-{{ connection.connection_type|yesno:'info,warning,success' }} border border-{{ connection.connection_type|yesno:'info,warning,success' }} border-opacity-25">
                                                    <i class="fas fa-server me-1"></i>{{ connection.connection_type }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="connection-status">
                                            <span class="badge bg-{{ connection.is_active|yesno:'success,secondary' }} rounded-pill">
                                                <i class="fas fa-{{ connection.is_active|yesno:'check,times' }} me-1"></i>
                                                {{ connection.is_active|yesno:'å¯ç”¨,ç¦ç”¨' }}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <!-- è¿æ¥åœ°å€ -->
                                    <div class="connection-url mb-3">
                                        <div class="url-container bg-light rounded p-2">
                                            <code class="small text-muted">{{ connection.url }}</code>
                                        </div>
                                    </div>
                                    
                                    <!-- ç™»å½•æŒ‰é’®ç»„ -->
                                    <div class="login-buttons">
                                        {% if connection.connection_type == 'wechatx' %}
                                        <div class="btn-group w-100 mb-2" role="group">
                                            <button class="btn btn-primary btn-sm" onclick="startLogin('{{ connection.id }}', 'ipad')">
                                                <i class="fas fa-tablet-alt me-1"></i>iPadç™»å½•
                                            </button>
                                            <button class="btn btn-info btn-sm" onclick="startLogin('{{ connection.id }}', 'ipad_backup')">
                                                <i class="fas fa-shield-alt me-1"></i>iPadå¤‡ç”¨
                                            </button>
                                        </div>
                                        <button class="btn btn-warning btn-sm w-100" onclick="startLogin('{{ connection.id }}', 'car')">
                                            <i class="fas fa-car me-1"></i>è½¦è½½ç™»å½•
                                        </button>
                                        {% elif connection.connection_type == 'wechatx-861' %}
                                        <button class="btn btn-primary btn-sm w-100" onclick="startLogin('{{ connection.id }}', '861_ipad')">
                                            <i class="fas fa-tablet-alt me-1"></i>861-iPadç™»å½•
                                        </button>
                                        {% elif connection.connection_type == 'WeCharPadPro' %}
                                        <div class="btn-group w-100 mb-2" role="group">
                                            <button class="btn btn-success btn-sm" onclick="generateAuthCode('{{ connection.id }}')">
                                                <i class="fas fa-key me-1"></i>ç”Ÿæˆæˆæƒç 
                                            </button>
                                            <button class="btn btn-primary btn-sm" onclick="loginPro('{{ connection.id }}')">
                                                <i class="fas fa-crown me-1"></i>ç™»å½•Pro
                                            </button>
                                        </div>
                                        {% else %}
                                        <div class="text-muted text-center py-2">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            <small>è¯¥è¿æ¥ç±»å‹ä¸æ”¯æŒå¾®ä¿¡ç™»å½•</small>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state text-center py-5">
                        <div class="empty-icon mb-4">
                            <i class="fas fa-link fa-4x text-muted opacity-50"></i>
                        </div>
                        <h4 class="text-muted mb-3">æš‚æ— å¯ç”¨è¿æ¥</h4>
                        <p class="text-muted mb-4">è¯·å…ˆæ·»åŠ wechatxã€wechatx-861æˆ–WeCharPadProç±»å‹çš„è¿æ¥</p>
                        <a href="{% url 'connection_create' %}" class="btn btn-primary btn-lg">
                            <i class="fas fa-plus me-2"></i>æ·»åŠ è¿æ¥
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- æˆæƒç è‡ªåŠ¨ç™»å½•åŒºåŸŸ -->
    {% if connections %}
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-gradient-success text-white border-0">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-key me-3 fa-lg"></i>
                        <h5 class="mb-0 fw-bold">æˆæƒç è‡ªåŠ¨ç™»å½•</h5>
                        <span class="badge bg-light text-success ms-auto">å¿«é€Ÿç™»å½•</span>
                    </div>
                </div>
                <div class="card-body p-4">
                    {% for connection in connections %}
                        {% if connection.auth_codes.all %}
                        <div class="connection-group mb-4">
                            <div class="connection-header d-flex align-items-center mb-3">
                                <h6 class="mb-0 text-dark fw-bold">{{ connection.name }}</h6>
                                <span class="badge bg-{{ connection.connection_type|yesno:'info,warning,success' }} bg-opacity-10 text-{{ connection.connection_type|yesno:'info,warning,success' }} ms-2">
                                    {{ connection.auth_codes.all|length }} ä¸ªæˆæƒç 
                                </span>
                            </div>
                            <div class="row g-3">
                                {% for auth_code in connection.auth_codes.all %}
                                <div class="col-lg-3 col-md-4 col-sm-6">
                                    <div class="auth-code-card card h-100 border-0 bg-light">
                                        <div class="card-body p-3">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <div class="auth-info flex-grow-1">
                                                    <div class="auth-name text-truncate fw-medium text-dark">
                                                        {{ auth_code.remark_display|default:"æœªçŸ¥è´¦å·" }}
                                                    </div>
                                                    <code class="small text-muted">{{ auth_code.code|truncatechars:15 }}</code>
                                                </div>
                                                <button class="btn btn-sm btn-outline-success rounded-pill" 
                                                        onclick="autoLogin('{{ connection.id }}', '{{ auth_code.id }}')"
                                                        title="ä¸€é”®ç™»å½•">
                                                    <i class="fas fa-sign-in-alt"></i>
                                                </button>
                                            </div>
                                            {% if auth_code.is_online is not None %}
                                            <div class="auth-status mt-2">
                                                <span class="badge bg-{{ auth_code.is_online|yesno:'success,danger' }} bg-opacity-10 text-{{ auth_code.is_online|yesno:'success,danger' }} rounded-pill">
                                                    <i class="fas fa-circle fa-xs me-1"></i>
                                                    {{ auth_code.is_online|yesno:'åœ¨çº¿,ç¦»çº¿' }}
                                                </span>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    {% empty %}
                    <div class="text-center py-4">
                        <i class="fas fa-key fa-3x text-muted opacity-50 mb-3"></i>
                        <h6 class="text-muted">æš‚æ— æˆæƒç </h6>
                        <p class="text-muted small">è¯·å…ˆåœ¨è¿æ¥ç®¡ç†ä¸­æ·»åŠ å¾®ä¿¡æˆæƒç </p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- äºŒç»´ç ç™»å½•æ¨¡æ€æ¡† -->
<div class="modal fade" id="qrLoginModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fab fa-weixin me-2 text-success"></i>æ‰«ç ç™»å½•
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="handleCancelClick()"></button>
            </div>
            <div class="modal-body text-center">
                <div id="qrCodeContainer">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>æ­£åœ¨ç”ŸæˆäºŒç»´ç ...</p>
                </div>
                <div id="statusMessage" class="mt-3">
                    <p class="text-muted">è¯·ä½¿ç”¨å¾®ä¿¡æ‰«æäºŒç»´ç ç™»å½•</p>
                </div>
                <div class="progress mt-3" style="height: 6px;">
                    <div class="progress-bar" role="progressbar" style="width: 100%"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="handleCancelClick()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
</div>

<script>
// å…¨å±€å˜é‡
let currentSession = null;
let statusCheckInterval = null;
let isStatusCheckStopped = false;

// è·å– CSRF token - å…¨å±€å‡½æ•°
function getCSRFToken() {
    // ä»è¡¨å•ä¸­è·å–
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        return csrfToken.value;
    }
    // å°è¯•ä» cookie è·å–
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return decodeURIComponent(value);
        }
    }
    return '';
}

// å¼€å§‹ç™»å½•
function startLogin(connectionId, loginType) {
    // å…ˆåœæ­¢ä»»ä½•ç°æœ‰çš„çŠ¶æ€æ£€æŸ¥
    stopStatusCheck();
    
    // ä½¿ç”¨ Bootstrap 5 çš„æ–¹å¼æ˜¾ç¤ºæ¨¡æ€æ¡†
    const modalElement = document.getElementById('qrLoginModal');
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    }
    
    // é‡ç½®çŠ¶æ€
    const qrContainer = document.getElementById('qrCodeContainer');
    const statusMsg = document.getElementById('statusMessage');
    
    if (qrContainer) {
        qrContainer.innerHTML = `
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>æ­£åœ¨ç”ŸæˆäºŒç»´ç ...</p>
        `;
    }
    if (statusMsg) {
        statusMsg.innerHTML = '<p class="text-muted">è¯·ä½¿ç”¨å¾®ä¿¡æ‰«æäºŒç»´ç ç™»å½•</p>';
    }
    
    // è·å–äºŒç»´ç  - ä½¿ç”¨åŸç”Ÿ fetch API
    fetch(`/dashboard/wechat-login/${connectionId}/qr/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            type: loginType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.code === 200) {
            currentSession = data.data.session_id;
            
            // æ˜¾ç¤ºäºŒç»´ç 
            if (qrContainer) {
                qrContainer.innerHTML = `
                    <img src="${data.data.qr_image}" class="img-fluid mb-3" style="max-width: 240px;">
                    <p class="text-muted">äºŒç»´ç æœ‰æ•ˆæœŸ: 100ç§’</p>
                `;
            }
            
            // å¼€å§‹æ£€æŸ¥çŠ¶æ€
            startStatusCheck();
            
            // è®¾ç½®è¿‡æœŸæ—¶é—´
            setTimeout(() => {
                if (currentSession) {
                    if (statusMsg) {
                        statusMsg.innerHTML = '<p class="text-danger">äºŒç»´ç å·²è¿‡æœŸï¼Œè¯·é‡æ–°è·å–</p>';
                    }
                    stopStatusCheck();
                }
            }, 100000);
            
        } else {
            if (qrContainer) {
                qrContainer.innerHTML = `
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <p class="text-danger">${data.msg}</p>
                `;
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (qrContainer) {
            qrContainer.innerHTML = `
                <i class="fas fa-times-circle fa-3x text-danger mb-3"></i>
                <p class="text-danger">è·å–äºŒç»´ç å¤±è´¥ï¼š${error.message || 'ç½‘ç»œé”™è¯¯'}</p>
            `;
        }
    });
}

// å¼€å§‹çŠ¶æ€æ£€æŸ¥
function startStatusCheck() {
    if (!currentSession) return;
    
    console.log('å¼€å§‹çŠ¶æ€æ£€æŸ¥ï¼Œä¼šè¯ID:', currentSession);
    isStatusCheckStopped = false;
    
    statusCheckInterval = setInterval(() => {
        if (!currentSession || isStatusCheckStopped) {
            console.log('ä¼šè¯å·²æ¸…ç©ºæˆ–å·²åœæ­¢ï¼Œåœæ­¢çŠ¶æ€æ£€æŸ¥');
            stopStatusCheck();
            return;
        }
        
        console.log('æ‰§è¡ŒçŠ¶æ€æ£€æŸ¥ï¼Œä¼šè¯ID:', currentSession);
        
        // ä½¿ç”¨ fetch API
        fetch(`/dashboard/wechat-login/session/${currentSession}/status/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(response => {
            // æ£€æŸ¥æ˜¯å¦å·²ç»åœæ­¢çŠ¶æ€æ£€æŸ¥
            if (isStatusCheckStopped || !currentSession) {
                console.log('çŠ¶æ€æ£€æŸ¥å·²åœæ­¢ï¼Œå¿½ç•¥å“åº”');
                return;
            }
            
            if (response.code === 200) {
                const data = response.data;
                const statusMsg = document.getElementById('statusMessage');
                
                if (data.status === 'success') {
                    if (statusMsg) {
                        statusMsg.innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                ç™»å½•æˆåŠŸï¼<br>
                                <small>wxid: ${data.wxid}<br>æ˜µç§°: ${data.nickname}</small>
                            </div>
                        `;
                    }
                    stopStatusCheck();
                    setTimeout(() => {
                        const modalElement = document.getElementById('qrLoginModal');
                        if (modalElement) {
                            const modal = bootstrap.Modal.getInstance(modalElement);
                            if (modal) {
                                modal.hide();
                            }
                        }
                        showMessage('ç™»å½•æˆåŠŸï¼', 'success');
                    }, 2000);
                    
                } else if (data.status === 'scanned') {
                    if (statusMsg) {
                        statusMsg.innerHTML = `
                            <div class="alert alert-info">
                                <i class="fas fa-mobile-alt me-2"></i>
                                ${data.message}
                            </div>
                        `;
                    }
                    
                } else if (data.status === 'expired') {
                    if (statusMsg) {
                        statusMsg.innerHTML = `
                            <div class="alert alert-warning">
                                <i class="fas fa-clock me-2"></i>
                                äºŒç»´ç å·²è¿‡æœŸ
                            </div>
                        `;
                    }
                    stopStatusCheck();
                    
                } else if (data.status === 'failed') {
                    if (statusMsg) {
                        statusMsg.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-times-circle me-2"></i>
                                ${data.message}
                            </div>
                        `;
                    }
                    stopStatusCheck();
                    
                } else if (data.status === 'cancelled') {
                    console.log('æ£€æµ‹åˆ°ä¼šè¯å·²å–æ¶ˆ');
                    if (statusMsg) {
                        statusMsg.innerHTML = `
                            <div class="alert alert-secondary">
                                <i class="fas fa-ban me-1"></i>
                                ç™»å½•å·²å–æ¶ˆ
                            </div>
                        `;
                    }
                    stopStatusCheck();
                    setTimeout(() => {
                        const modalElement = document.getElementById('qrLoginModal');
                        if (modalElement) {
                            const modal = bootstrap.Modal.getInstance(modalElement);
                            if (modal) {
                                modal.hide();
                            }
                        }
                    }, 2000);
                }
            }
        })
        .catch(error => {
            // é™é»˜å¤„ç†é”™è¯¯ï¼Œç»§ç»­æ£€æŸ¥
            console.error('Status check error:', error);
        });
    }, 2000);
}

// åœæ­¢çŠ¶æ€æ£€æŸ¥
function stopStatusCheck() {
    console.log('åœæ­¢çŠ¶æ€æ£€æŸ¥ï¼Œå½“å‰interval:', statusCheckInterval);
    isStatusCheckStopped = true;
    if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
        statusCheckInterval = null;
        console.log('çŠ¶æ€æ£€æŸ¥å·²åœæ­¢');
    }
    currentSession = null;
}

// è‡ªåŠ¨ç™»å½•
function autoLogin(connectionId, codeId) {
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;
    
    fetch(`/dashboard/wechat-login/${connectionId}/auto-login/${codeId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.code === 200) {
            showMessage('è‡ªåŠ¨ç™»å½•æˆåŠŸï¼', 'success');
        } else if (data.code === 202) {
            // éœ€è¦æ‰«ç ç™»å½•
            showMessage('éœ€è¦æ‰«ç ç™»å½•ï¼Œæ­£åœ¨è·å–äºŒç»´ç ...', 'info');
            startLogin(connectionId, data.data.device_type);
        } else {
            showMessage('è‡ªåŠ¨ç™»å½•å¤±è´¥ï¼š' + data.msg, 'warning');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('è‡ªåŠ¨ç™»å½•å¤±è´¥ï¼šç½‘ç»œé”™è¯¯', 'danger');
    })
    .finally(() => {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    });
}

// æ˜¾ç¤ºæ¶ˆæ¯
function showMessage(message, type = 'info') {
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'danger': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    }[type] || 'alert-info';
    
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // ç§»é™¤ç°æœ‰çš„alert
    const existingAlerts = document.querySelectorAll('.alert');
    existingAlerts.forEach(alert => alert.remove());
    
    // æ·»åŠ æ–°çš„alertåˆ°é¡µé¢é¡¶éƒ¨
    const h2 = document.querySelector('h2');
    if (h2 && h2.parentNode) {
        const alertDiv = document.createElement('div');
        alertDiv.innerHTML = alertHtml;
        h2.parentNode.insertBefore(alertDiv.firstElementChild, h2.nextSibling);
        
        // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            const alert = alertDiv.firstElementChild;
            if (alert) {
                alert.style.transition = 'opacity 0.5s';
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 500);
            }
        }, 3000);
    }
}


// å¤„ç†å–æ¶ˆæŒ‰é’®ç‚¹å‡»
function handleCancelClick() {
    console.log('ç”¨æˆ·ç‚¹å‡»å–æ¶ˆæŒ‰é’®');
    stopStatusCheck();
    if (currentSession) {
        cancelQRSession(currentSession);
    }
}

// å–æ¶ˆäºŒç»´ç ä¼šè¯
function cancelQRSession(sessionId) {
    console.log('æ­£åœ¨å–æ¶ˆä¼šè¯:', sessionId);
    fetch(`/dashboard/wechat-login/session/${sessionId}/cancel/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('ä¼šè¯å·²å–æ¶ˆ:', data.msg);
    })
    .catch(error => {
        console.log('å–æ¶ˆä¼šè¯å¤±è´¥:', error.message || 'ç½‘ç»œé”™è¯¯');
    });
}

// WeCharPadPro - ç”Ÿæˆæˆæƒç 
function generateAuthCode(connectionId) {
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ç”Ÿæˆä¸­...';
    btn.disabled = true;
    
    // è¯¢é—®ç”¨æˆ·ç”Ÿæˆå¤©æ•°
    const days = prompt('è¯·è¾“å…¥æˆæƒç æœ‰æ•ˆå¤©æ•°ï¼ˆé»˜è®¤30å¤©ï¼‰ï¼š', '30');
    if (!days || isNaN(days) || parseInt(days) <= 0) {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        if (days !== null) {
            showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„å¤©æ•°', 'warning');
        }
        return;
    }
    
    fetch(`/dashboard/api/connections/${connectionId}/generate-auth-code/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            days: parseInt(days)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.code === 200) {
            const authCodes = data.data.auth_codes;
            if (authCodes && authCodes.length > 0) {
                let message = `ğŸ‰ æˆæƒç ç”ŸæˆæˆåŠŸï¼\nç”Ÿæˆæ•°é‡: ${authCodes.length}`;
                authCodes.forEach((code, index) => {
                    message += `\n${index + 1}. ${code}`;
                });
                
                // è¯¢é—®æ˜¯å¦æ·»åŠ åˆ°ç³»ç»Ÿ
                if (confirm('æ˜¯å¦å°†ç”Ÿæˆçš„æˆæƒç æ·»åŠ åˆ°ç³»ç»Ÿä¸­ï¼Ÿ')) {
                    addAuthCodesToSystem(connectionId, authCodes);
                }
                
                showMessage(message, 'success');
            } else {
                showMessage('æˆæƒç ç”ŸæˆæˆåŠŸï¼Œä½†æœªè¿”å›æˆæƒç ä¿¡æ¯', 'info');
            }
        } else {
            showMessage('ç”Ÿæˆæˆæƒç å¤±è´¥ï¼š' + data.msg, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('ç”Ÿæˆæˆæƒç å¤±è´¥ï¼šç½‘ç»œé”™è¯¯', 'danger');
    })
    .finally(() => {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    });
}

// WeCharPadPro - ç™»å½•Pro
function loginPro(connectionId) {
    // ç›´æ¥è·³è½¬åˆ°è¿æ¥è¯¦æƒ…é¡µé¢
    window.location.href = `/dashboard/connections/${connectionId}/`;
}

// æ·»åŠ æˆæƒç åˆ°ç³»ç»Ÿ
function addAuthCodesToSystem(connectionId, authCodes) {
    let addedCount = 0;
    let totalCount = authCodes.length;
    
    authCodes.forEach((code, index) => {
        const remark = prompt(`è¯·ä¸ºæˆæƒç  ${code.substring(0, 8)}... è¾“å…¥å¤‡æ³¨åç§°ï¼š`, `Proæˆæƒç -${index + 1}`);
        if (remark !== null) {
            fetch(`/dashboard/api/connections/${connectionId}/auth-codes/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: code,
                    remark: remark
                })
            })
            .then(response => response.json())
            .then(data => {
                addedCount++;
                if (addedCount === totalCount) {
                    showMessage(`âœ… æˆåŠŸæ·»åŠ  ${addedCount} ä¸ªæˆæƒç åˆ°ç³»ç»Ÿ`, 'success');
                    // åˆ·æ–°æˆæƒç è‡ªåŠ¨ç™»å½•åŒºåŸŸ
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage(`æ·»åŠ æˆæƒç  ${code.substring(0, 8)}... å¤±è´¥ï¼šç½‘ç»œé”™è¯¯`, 'warning');
            });
        }
    });
}

// é¡µé¢åŠ è½½å®Œæˆ - ç¡®ä¿æ‰€æœ‰å‡½æ•°åœ¨å…¨å±€å¯ç”¨
(function() {
    // å°†æ‰€æœ‰å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.getCSRFToken = getCSRFToken;
    window.startLogin = startLogin;
    window.autoLogin = autoLogin;
    window.generateAuthCode = generateAuthCode;
    window.loginPro = loginPro;
    window.handleCancelClick = handleCancelClick;
    window.stopStatusCheck = stopStatusCheck;
    window.startStatusCheck = startStatusCheck;
    window.cancelQRSession = cancelQRSession;
    window.showMessage = showMessage;
    window.addAuthCodesToSystem = addAuthCodesToSystem;
    
    // DOM åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        // console.log('å¾®ä¿¡ç™»å½•é¡µé¢åŠ è½½å®Œæˆ');
        
        // æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬
        const modalElement = document.getElementById('qrLoginModal');
        if (modalElement) {
            // Bootstrap 5 äº‹ä»¶ç›‘å¬
            modalElement.addEventListener('hidden.bs.modal', function() {
                //  console.log('æ¨¡æ€æ¡†å…³é—­ï¼Œå½“å‰ä¼šè¯:', currentSession);
                
                // ç«‹å³åœæ­¢çŠ¶æ€æ£€æŸ¥
                stopStatusCheck();
                
                // å¦‚æœæœ‰æ´»è·ƒçš„ä¼šè¯ï¼Œå–æ¶ˆå®ƒ
                if (currentSession) {
                    cancelQRSession(currentSession);
                }
            });
            
            modalElement.addEventListener('hide.bs.modal', function() {
                console.log('æ¨¡æ€æ¡†å¼€å§‹å…³é—­ï¼Œç«‹å³åœæ­¢çŠ¶æ€æ£€æŸ¥');
                stopStatusCheck();
            });
        }
    });
})();
</script>

<style>
/* å¾®ä¿¡ç™»å½•é¡µé¢æ ·å¼ */
.fade-in {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* è¿æ¥å¡ç‰‡æ ·å¼ */
.connection-card {
    transition: all 0.3s ease;
    border-radius: 12px;
    overflow: hidden;
}

.connection-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.1) !important;
}

.connection-info h6 {
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
}

.connection-type .badge {
    font-size: 0.75rem;
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
}

.connection-status .badge {
    font-size: 0.7rem;
    padding: 0.3rem 0.6rem;
}

.url-container {
    border: 1px solid #e9ecef;
}

.url-container code {
    color: #6c757d;
    background: transparent;
    font-size: 0.8rem;
}

/* ç™»å½•æŒ‰é’®æ ·å¼ */
.login-buttons .btn {
    font-size: 0.85rem;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.login-buttons .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.login-buttons .btn i {
    font-size: 0.9rem;
}

/* æˆæƒç å¡ç‰‡æ ·å¼ */
.auth-code-card {
    transition: all 0.3s ease;
    border-radius: 10px;
    background: #f8f9fa !important;
    border: 1px solid #e9ecef;
}

.auth-code-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.08) !important;
    background: #ffffff !important;
}

.auth-info .auth-name {
    font-size: 0.9rem;
    line-height: 1.3;
}

.auth-info code {
    font-size: 0.75rem;
    background: transparent;
    color: #6c757d;
    padding: 0;
}

.auth-status .badge {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
}

/* è¿æ¥ç»„æ ·å¼ */
.connection-group {
    border-bottom: 1px solid #f0f0f0;
    padding-bottom: 1.5rem;
}

.connection-group:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.connection-header h6 {
    color: #2c3e50;
    font-size: 1rem;
}

.connection-header .badge {
    font-size: 0.7rem;
    padding: 0.3rem 0.6rem;
}

/* å¡ç‰‡å¤´éƒ¨æ¸å˜ */
.bg-gradient-primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
}

.bg-gradient-success {
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%) !important;
}

/* ç©ºçŠ¶æ€æ ·å¼ */
.empty-state {
    padding: 3rem 2rem;
}

.empty-icon {
    margin-bottom: 1.5rem;
}

.empty-state h4 {
    font-weight: 600;
    margin-bottom: 1rem;
}

.empty-state p {
    font-size: 1rem;
    line-height: 1.6;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
    .connection-card .card-body {
        padding: 1.5rem;
    }
    
    .login-buttons .btn {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
    }
    
    .auth-code-card .card-body {
        padding: 0.75rem;
    }
    
    .connection-header h6 {
        font-size: 0.9rem;
    }
    
    .empty-state {
        padding: 2rem 1rem;
    }
}

@media (max-width: 576px) {
    .connection-card {
        margin-bottom: 1rem;
    }
    
    .btn-group {
        flex-direction: column;
    }
    
    .btn-group .btn {
        border-radius: 8px !important;
        margin-bottom: 0.5rem;
    }
    
    .btn-group .btn:last-child {
        margin-bottom: 0;
    }
}

/* äºŒç»´ç æ¨¡æ€æ¡†æ ·å¼å¢å¼º */
.modal-content {
    border-radius: 15px;
    border: none;
    box-shadow: 0 20px 60px rgba(0,0,0,0.15);
}

.modal-header {
    border-bottom: 1px solid #f0f0f0;
    padding: 1.5rem;
}

.modal-body {
    padding: 2rem;
}

.modal-footer {
    border-top: 1px solid #f0f0f0;
    padding: 1rem 1.5rem;
}

#qrCodeContainer img {
    border-radius: 10px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.progress {
    border-radius: 10px;
    overflow: hidden;
}

.progress-bar {
    transition: width 0.3s ease;
}

/* è¿›åº¦æ¡åŠ¨ç”» */
.progress-bar {
    animation: progress-animation 100s linear;
}

@keyframes progress-animation {
    from { width: 100%; }
    to { width: 0%; }
}
</style>
{% endblock %}
